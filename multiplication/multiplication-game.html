<!-- Multiplication Game | O. Kazimirov | oleksandr.kazimirov@gmail.com -->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Multiplication Game</title>
    <style>
        :root {
            --primary: #4A90D9;
            --primary-dark: #357ABD;
            --success: #4CAF50;
            --success-dark: #2E7D32;
            --error: #E53935;
            --error-dark: #C62828;
            --warning: #F57C00;
            --gray-100: #f5f7fa;
            --gray-200: #e4e8ec;
            --gray-300: #e0e0e0;
            --gray-400: #999;
            --gray-600: #666;
            --gray-800: #333;
            --radius-sm: 8px;
            --radius-md: 12px;
            --radius-lg: 16px;
            --radius-xl: 24px;
            --shadow: 0 10px 40px rgba(0,0,0,.1);
            --shadow-btn: 0 4px 15px rgba(74,144,217,.4);
        }

        * { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, var(--gray-100), var(--gray-200));
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        /* Layout */
        .container { width: 100%; max-width: 500px; }

        .screen {
            display: none;
            background: #fff;
            border-radius: var(--radius-xl);
            padding: 32px;
            box-shadow: var(--shadow);
            position: relative;
        }

        .screen.active { display: block; animation: fadeIn .3s ease; }

        /* Animations */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            20%, 60% { transform: translateX(-8px); }
            40%, 80% { transform: translateX(8px); }
        }

        @keyframes popIn {
            0% { transform: scale(.5); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }

        /* Typography */
        h1, h2 { text-align: center; color: var(--gray-800); margin-bottom: 24px; }
        h1 { font-size: 28px; margin-bottom: 32px; }
        h2 { font-size: 24px; }

        /* Form Elements */
        .setting-group { margin-bottom: 24px; }

        .setting-label {
            display: block;
            font-size: 16px;
            color: var(--gray-600);
            margin-bottom: 12px;
            font-weight: 500;
        }

        .slider-container { display: flex; align-items: center; gap: 16px; }

        .slider {
            flex: 1;
            height: 8px;
            -webkit-appearance: none;
            background: var(--gray-300);
            border-radius: 4px;
            outline: none;
        }

        .slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 28px;
            height: 28px;
            background: var(--primary);
            border-radius: 50%;
            cursor: pointer;
            box-shadow: var(--shadow-btn);
        }

        .slider-value {
            font-size: 24px;
            font-weight: 600;
            color: var(--primary);
            min-width: 40px;
            text-align: center;
        }

        .select-wrapper { position: relative; }

        .select-wrapper::after {
            content: '';
            position: absolute;
            right: 20px;
            top: 50%;
            transform: translateY(-50%);
            border: 6px solid transparent;
            border-top-color: var(--gray-600);
            pointer-events: none;
        }

        select {
            width: 100%;
            padding: 16px 20px;
            font-size: 18px;
            border: 2px solid var(--gray-300);
            border-radius: var(--radius-md);
            background: #fff;
            color: var(--gray-800);
            cursor: pointer;
            appearance: none;
            outline: none;
            transition: border-color .2s;
        }

        select:focus { border-color: var(--primary); }

        .settings-row { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }

        .fixed-mode-settings { transition: opacity .3s; overflow: hidden; }
        .fixed-mode-settings.hidden { opacity: .4; pointer-events: none; }

        /* Buttons */
        .btn {
            display: block;
            width: 100%;
            padding: 18px 32px;
            font-size: 20px;
            font-weight: 600;
            border: none;
            border-radius: var(--radius-lg);
            cursor: pointer;
            transition: transform .1s, box-shadow .2s;
            margin-bottom: 12px;
        }

        .btn:last-child { margin-bottom: 0; }
        .btn:active { transform: scale(.97); }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: #fff;
            box-shadow: var(--shadow-btn);
        }

        .btn-secondary {
            background: linear-gradient(135deg, #66BB6A, #43A047);
            color: #fff;
            box-shadow: 0 4px 15px rgba(76,175,80,.4);
        }

        .btn-outline {
            background: #fff;
            color: var(--primary);
            border: 2px solid var(--primary);
            box-shadow: none;
        }

        .btn-outline:active { background: var(--gray-100); }
        .btn-success {
            background: linear-gradient(135deg, var(--success), var(--success-dark));
            color: #fff;
            box-shadow: 0 4px 15px rgba(76,175,80,.4);
        }
        .btn-link {
            display: block;
            width: 100%;
            padding: 12px;
            font-size: 16px;
            font-weight: 500;
            color: var(--gray-400);
            background: none;
            border: none;
            cursor: pointer;
            text-align: center;
            transition: color .2s;
        }
        .btn-link:hover, .btn-link:active { color: var(--gray-600); }

        /* Game Screen */
        .game-header {
            margin-bottom: 24px;
            padding: 12px 16px;
            background: var(--gray-100);
            border-radius: var(--radius-md);
        }
        .header-top {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }
        .header-bottom {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 12px;
        }
        .header-btn {
            width: 40px;
            height: 40px;
            border: 2px solid var(--gray-300);
            border-radius: var(--radius-sm);
            background: #fff;
            font-size: 20px;
            cursor: pointer;
            transition: all .2s;
        }
        .header-btn:active { transform: scale(.95); }
        .header-btn.off { opacity: 0.4; }
        .timer { color: var(--warning); font-family: monospace; font-size: 24px; font-weight: 600; }
        .progress-text, .mistakes, .remaining { font-size: 16px; font-weight: 500; }
        .progress-text { color: var(--gray-600); }
        .mistakes { color: var(--error); }
        .remaining { color: var(--primary); }

        .problem {
            text-align: center;
            font-size: 48px;
            font-weight: 700;
            color: var(--gray-800);
            margin-bottom: 24px;
            padding: 24px;
            background: var(--gray-100);
            border-radius: var(--radius-lg);
            letter-spacing: 4px;
        }

        .problem .unknown { color: var(--primary); font-weight: 800; }

        .answer-display {
            text-align: center;
            font-size: 42px;
            font-weight: 700;
            color: var(--gray-800);
            padding: 20px;
            margin-bottom: 20px;
            background: var(--gray-100);
            border-radius: var(--radius-lg);
            min-height: 80px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background .3s, transform .1s;
        }

        .answer-display.correct { background: #E8F5E9; color: var(--success-dark); }
        .answer-display.wrong { background: #FFEBEE; color: var(--error-dark); animation: shake .4s ease; }

        /* Numpad */
        .numpad { display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; margin-bottom: 20px; }

        .num-btn {
            padding: 20px;
            font-size: 28px;
            font-weight: 600;
            border: none;
            border-radius: var(--radius-lg);
            background: #f0f0f0;
            color: var(--gray-800);
            cursor: pointer;
            transition: background .1s, transform .1s;
        }

        .num-btn:active { background: var(--gray-300); transform: scale(.95); }
        .num-btn.clear { background: #FFEBEE; color: var(--error); }
        .num-btn.zero { grid-column: span 2; }
        .input-row { display: grid; grid-template-columns: 2fr 1fr; gap: 12px; }
        .mic-btn {
            padding: 20px;
            font-size: 28px;
            font-weight: 600;
            border: none;
            border-radius: var(--radius-lg);
            background: #E3F2FD;
            color: var(--primary);
            cursor: pointer;
            transition: all .2s;
        }
        .mic-btn:active { transform: scale(.95); }
        .mic-btn.listening { background: #FFEBEE; color: var(--error); animation: pulse 1s infinite; }
        .mic-btn.disabled { opacity: 0.3; pointer-events: none; }
        @keyframes pulse { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.05); } }

        /* Results */
        .score-summary {
            text-align: center;
            padding: 24px;
            background: linear-gradient(135deg, #E3F2FD, #BBDEFB);
            border-radius: var(--radius-lg);
            margin-bottom: 24px;
        }

        .score-summary.success { background: linear-gradient(135deg, #E8F5E9, #C8E6C9); }

        .score-big { font-size: 48px; font-weight: 700; color: #1976D2; }
        .score-summary.success .score-big { color: var(--success-dark); }
        .score-percent { font-size: 20px; color: var(--gray-600); margin-top: 8px; }

        .results-list {
            max-height: 300px;
            overflow-y: auto;
            margin-bottom: 24px;
            border: 2px solid var(--gray-300);
            border-radius: var(--radius-lg);
        }

        .result-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px 20px;
            border-bottom: 1px solid #f0f0f0;
            font-size: 18px;
        }

        .result-item:last-child { border-bottom: none; }
        .result-item.correct { background: #F1F8E9; }
        .result-item.wrong { background: #FFEBEE; }

        .result-problem { font-weight: 600; color: var(--gray-800); }
        .result-status { font-weight: 600; }
        .result-status.correct { color: var(--success-dark); }
        .result-status.wrong { color: var(--error-dark); }

        .game-over-message {
            text-align: center;
            padding: 20px;
            background: #FFEBEE;
            border-radius: var(--radius-md);
            margin-bottom: 20px;
            color: var(--error-dark);
            font-weight: 600;
            font-size: 18px;
        }

        .game-over-message.success { background: #E8F5E9; color: var(--success-dark); }

        /* Congrats Overlay */
        .congrats-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: opacity .3s, visibility .3s;
        }

        .congrats-overlay.show { opacity: 1; visibility: visible; }

        .congrats-popup {
            background: #fff;
            padding: 40px;
            border-radius: var(--radius-xl);
            text-align: center;
            transform: scale(.8);
            transition: transform .3s;
            box-shadow: 0 20px 60px rgba(0,0,0,.3);
        }

        .congrats-overlay.show .congrats-popup { transform: scale(1); animation: popIn .4s ease; }

        .congrats-emoji { font-size: 64px; margin-bottom: 16px; }
        .congrats-text { font-size: 28px; font-weight: 700; color: var(--success); margin-bottom: 8px; }
        .congrats-subtext { font-size: 18px; color: var(--gray-600); }

        /* Number Selector */
        .combo-info { font-size: 14px; color: var(--gray-400); margin-top: 8px; text-align: center; }

        .number-selector { display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; margin-bottom: 24px; }

        .number-btn {
            padding: 16px;
            font-size: 24px;
            font-weight: 700;
            border: 3px solid var(--gray-300);
            border-radius: var(--radius-lg);
            background: #fff;
            color: var(--gray-800);
            cursor: pointer;
            transition: all .2s;
        }

        .number-btn:active { transform: scale(.95); }

        .number-btn.selected {
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: #fff;
            border-color: var(--primary-dark);
            box-shadow: var(--shadow-btn);
        }

        /* Language Selector */
        .language-selector { display: flex; gap: 12px; justify-content: center; }

        .lang-btn {
            padding: 12px 20px;
            font-size: 18px;
            font-weight: 600;
            border: 3px solid var(--gray-300);
            border-radius: var(--radius-lg);
            background: #fff;
            color: var(--gray-800);
            cursor: pointer;
            transition: all .2s;
        }

        .lang-btn:active { transform: scale(.95); }

        .lang-btn.selected {
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: #fff;
            border-color: var(--primary-dark);
            box-shadow: var(--shadow-btn);
        }

        /* About Button & Overlay */
        .btn-about {
            position: absolute;
            top: 16px;
            right: 16px;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            border: 2px solid var(--gray-300);
            background: #fff;
            color: var(--gray-600);
            font-size: 18px;
            cursor: pointer;
            transition: all .2s;
        }

        .btn-about:hover { border-color: var(--primary); color: var(--primary); }

        .about-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: opacity .3s, visibility .3s;
        }

        .about-overlay.show { opacity: 1; visibility: visible; }

        .about-popup {
            background: #fff;
            padding: 32px;
            border-radius: var(--radius-xl);
            max-width: 320px;
            text-align: center;
            position: relative;
            box-shadow: 0 20px 60px rgba(0,0,0,.3);
        }

        .about-close {
            position: absolute;
            top: 12px;
            right: 12px;
            width: 28px;
            height: 28px;
            border: none;
            background: var(--gray-100);
            border-radius: 50%;
            font-size: 20px;
            color: var(--gray-600);
            cursor: pointer;
            line-height: 1;
        }

        .about-close:hover { background: var(--gray-200); }

        .about-popup h3 { margin-bottom: 16px; color: var(--gray-800); }
        .about-text { color: var(--gray-600); margin-bottom: 16px; line-height: 1.5; }
        .about-author { color: var(--gray-800); font-weight: 600; margin-bottom: 8px; }
        .about-contact { font-size: 14px; }
        .about-contact a { color: var(--primary); text-decoration: none; }
        .about-contact a:hover { text-decoration: underline; }

        /* Learn Screen */
        .multiplication-table {
            background: linear-gradient(135deg, #FFF8E1, #FFECB3);
            border-radius: var(--radius-lg);
            padding: 24px;
            margin-bottom: 24px;
        }

        .table-title {
            text-align: center;
            font-size: 24px;
            font-weight: 700;
            color: var(--warning);
            margin-bottom: 20px;
        }

        .table-content { display: flex; flex-direction: column; gap: 8px; }

        .table-row {
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 22px;
            font-weight: 600;
            color: var(--gray-800);
            padding: 8px 16px;
            background: rgba(255,255,255,.7);
            border-radius: var(--radius-sm);
        }

        .table-row span { min-width: 30px; }
        .table-row .multiplier { color: var(--warning); text-align: right; }
        .table-row .operator, .table-row .equals { color: var(--gray-600); margin: 0 8px; min-width: auto; }
        .table-row .result { color: var(--success-dark); font-weight: 700; min-width: 40px; text-align: right; }

        .learn-hint { text-align: center; color: var(--gray-600); font-size: 16px; margin-bottom: 16px; }

        /* Responsive Design */
        @media (max-width: 400px) {
            body { padding: 10px; }
            .screen { padding: 20px; border-radius: var(--radius-lg); }
            h1 { font-size: 24px; margin-bottom: 24px; }
            h2 { font-size: 20px; margin-bottom: 16px; }
            .problem { font-size: 36px; padding: 16px; margin-bottom: 16px; letter-spacing: 2px; }
            .answer-display { font-size: 32px; padding: 16px; min-height: 64px; margin-bottom: 16px; }
            .num-btn { padding: 14px; font-size: 22px; }
            .numpad { gap: 8px; margin-bottom: 16px; }
            .btn { padding: 14px 24px; font-size: 18px; }
            .setting-label { font-size: 14px; margin-bottom: 8px; }
            select { padding: 12px 16px; font-size: 16px; }
            .number-btn { padding: 12px; font-size: 20px; }
            .number-selector { gap: 8px; margin-bottom: 16px; }
            .table-row { font-size: 18px; padding: 6px 12px; }
            .progress-text, .mistakes, .remaining { font-size: 13px; }
            .timer { font-size: 20px; }
            .game-header { padding: 10px 12px; margin-bottom: 16px; }
            .header-btn { width: 36px; height: 36px; font-size: 18px; }
        }

        @media (min-width: 600px) {
            .container { max-width: 550px; }
            .problem { font-size: 56px; }
            .answer-display { font-size: 48px; min-height: 90px; }
            .num-btn { padding: 24px; font-size: 32px; }
        }

        @media (min-height: 900px) {
            .screen { padding: 40px; }
            .problem { font-size: 60px; padding: 32px; margin-bottom: 32px; }
            .answer-display { font-size: 52px; padding: 28px; min-height: 100px; margin-bottom: 28px; }
            .num-btn { padding: 28px; font-size: 36px; }
            .numpad { gap: 16px; margin-bottom: 28px; }
            .btn { padding: 22px 36px; font-size: 22px; }
        }

        /* Landscape orientation on tablets */
        @media (orientation: landscape) and (max-height: 500px) {
            body { padding: 8px; }
            .screen { padding: 16px; }
            .problem { font-size: 32px; padding: 12px; margin-bottom: 12px; }
            .answer-display { font-size: 28px; padding: 12px; min-height: 50px; margin-bottom: 12px; }
            .num-btn { padding: 10px; font-size: 20px; }
            .numpad { gap: 6px; margin-bottom: 12px; }
            .btn { padding: 12px 20px; font-size: 16px; margin-bottom: 8px; }
            .game-header { margin-bottom: 8px; padding: 8px 12px; }
            .header-top { margin-bottom: 4px; }
            .timer { font-size: 18px; }
            .header-btn { width: 32px; height: 32px; font-size: 16px; }
            h2 { font-size: 18px; margin-bottom: 12px; }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Menu Screen -->
        <div id="menu-screen" class="screen active">
            <h1 id="menu-title">Multiplication Game</h1>
            <div class="setting-group" style="margin-bottom:24px">
                <div class="language-selector">
                    <button class="lang-btn selected" data-lang="en">üá¨üáß English</button>
                    <button class="lang-btn" data-lang="uk">üá∫üá¶ –£–∫—Ä–∞—ó–Ω—Å—å–∫–∞</button>
                </div>
            </div>
            <button id="btn-play" class="btn btn-primary">PLAY</button>
            <button id="btn-learn" class="btn btn-secondary">LEARN</button>
            <button id="btn-about" class="btn-about">‚ìò</button>
        </div>

        <!-- Settings Screen -->
        <div id="settings-screen" class="screen">
            <h2>Game Settings</h2>

            <div class="setting-group">
                <label class="setting-label">Practice numbers up to:</label>
                <div class="slider-container">
                    <input type="range" id="input-max-number" class="slider" min="2" max="10" value="10">
                    <span id="display-max-number" class="slider-value">10</span>
                </div>
                <div id="display-combo-count" class="combo-info"></div>
            </div>

            <div class="setting-group">
                <label class="setting-label">Question Type:</label>
                <div class="select-wrapper">
                    <select id="select-game-mode">
                        <option value="result">Find the Result (A √ó B = ?)</option>
                        <option value="multiplier">Find the Multiplier (? √ó B = Z)</option>
                    </select>
                </div>
            </div>

            <div class="setting-group">
                <label class="setting-label">Session Type:</label>
                <div class="select-wrapper">
                    <select id="select-session-type">
                        <option value="fixed">Fixed Tasks</option>
                        <option value="practice-all">Practice All Tables</option>
                        <option value="practice-one">Practice One Table</option>
                    </select>
                </div>
            </div>

            <div id="practice-one-settings" class="setting-group" style="display:none">
                <label class="setting-label">Select table to practice:</label>
                <div class="number-selector" id="practice-one-selector"></div>
            </div>

            <div id="fixed-mode-settings" class="fixed-mode-settings">
                <div class="settings-row">
                    <div class="setting-group">
                        <label class="setting-label">Tasks:</label>
                        <div class="select-wrapper">
                            <select id="select-total-tasks">
                                <option value="5">5</option>
                                <option value="10" selected>10</option>
                                <option value="15">15</option>
                                <option value="20">20</option>
                            </select>
                        </div>
                    </div>
                    <div class="setting-group">
                        <label class="setting-label">Max Mistakes:</label>
                        <div class="select-wrapper">
                            <select id="select-max-mistakes">
                                <option value="1">1</option>
                                <option value="2">2</option>
                                <option value="3" selected>3</option>
                                <option value="0">Unlimited</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>

            <button id="btn-start" class="btn btn-success">START</button>
            <button id="btn-settings-back" class="btn-link">Back</button>
        </div>

        <!-- Learn Screen -->
        <div id="learn-screen" class="screen">
            <h2>Learn Tables</h2>
            <p class="learn-hint">Select a number to see its multiplication table:</p>
            <div class="number-selector" id="learn-selector"></div>
            <div id="multiplication-table" class="multiplication-table" style="display:none">
                <div class="table-title" id="table-title"></div>
                <div class="table-content" id="table-content"></div>
            </div>
            <button id="btn-learn-back" class="btn-link">Back to Menu</button>
        </div>

        <!-- Game Screen -->
        <div id="game-screen" class="screen">
            <div class="game-header">
                <div class="header-top">
                    <button id="btn-back-game" class="header-btn">‚Üê</button>
                    <span id="display-timer" class="timer">00:00</span>
                    <button id="btn-voice-toggle" class="header-btn voice-btn">üîä</button>
                </div>
                <div class="header-bottom">
                    <span id="display-progress" class="progress-text"></span>
                    <span id="display-mistakes"></span>
                </div>
            </div>
            <div id="display-problem" class="problem"></div>
            <div id="display-answer" class="answer-display"></div>
            <div class="numpad" id="numpad"></div>
            <div class="input-row">
                <button id="btn-check" class="btn btn-success">CHECK</button>
                <button id="btn-mic" class="mic-btn">üé§</button>
            </div>
        </div>

        <!-- Results Screen -->
        <div id="results-screen" class="screen">
            <h2>Results</h2>
            <div id="display-game-over" class="game-over-message" style="display:none"></div>
            <div id="display-score-summary" class="score-summary">
                <div id="display-score" class="score-big"></div>
                <div id="display-percent" class="score-percent"></div>
            </div>
            <div id="results-list" class="results-list"></div>
            <button id="btn-play-again" class="btn btn-success">PLAY AGAIN</button>
            <button id="btn-results-back" class="btn-link">Back to Menu</button>
        </div>
    </div>

    <!-- Congrats Overlay -->
    <div id="congrats-overlay" class="congrats-overlay">
        <div class="congrats-popup">
            <div class="congrats-emoji" id="congrats-emoji"></div>
            <div class="congrats-text" id="congrats-text"></div>
            <div class="congrats-subtext" id="congrats-subtext"></div>
        </div>
    </div>

    <!-- About Overlay -->
    <div id="about-overlay" class="about-overlay">
        <div class="about-popup">
            <button id="btn-about-close" class="about-close">√ó</button>
            <h3 id="about-title">About</h3>
            <p id="about-goal" class="about-text"></p>
            <p id="about-author" class="about-author"></p>
            <p class="about-contact"><a href="mailto:oleksandr.kazimirov@gmail.com">oleksandr.kazimirov@gmail.com</a></p>
        </div>
    </div>

    <!-- Voice Install Overlay -->
    <div id="voice-install-overlay" class="about-overlay">
        <div class="about-popup" style="max-width:360px;text-align:left">
            <button id="btn-voice-install-close" class="about-close">√ó</button>
            <h3 id="voice-install-title" style="text-align:center">Ukrainian Voice Not Found</h3>
            <p id="voice-install-text" class="about-text" style="margin-bottom:12px"></p>
            <div id="voice-install-instructions" style="font-size:14px;color:var(--gray-600);line-height:1.6"></div>
            <button id="btn-voice-install-ok" class="btn btn-primary" style="margin-top:16px">OK</button>
        </div>
    </div>

<script>
/**
 * Multiplication Game for Kids
 * OOP Architecture with ES6+ Classes
 */
(() => {
    'use strict';

    // =========================================================================
    // CONFIGURATION
    // =========================================================================

    const CONFIG = {
        TIMING: { CORRECT_DELAY: 500, WRONG_DELAY: 1000, AUTO_SUBMIT_DELAY: 2000, CONGRATS_DURATION: 1500, TIMER_INTERVAL: 1000 },
        GAME: { MIN_NUMBER: 2, MAX_NUMBER: 10, MULTIPLIER_RANGE: [1, 10], RETRY_POSITION: [3, 7] },
        CONGRATS: [['üåü','Great job!'],['üéâ','Amazing!'],['üèÜ','Fantastic!'],['‚≠ê','Super star!'],['üöÄ','Excellent!'],['üî•',"You're on fire!"],['üëè','Keep it up!'],['üí™','Math champion!'],['üéØ','Brilliant!'],['‚ú®','Outstanding!']]
    };

    const TRANSLATIONS = {
        en: { menuTitle:'Multiplication Game',play:'PLAY',learn:'LEARN',settings:'Game Settings',practiceUpTo:'Practice numbers up to:',questionType:'Question Type:',findResult:'Find the Result (A √ó B = ?)',findMultiplier:'Find the Multiplier (? √ó B = Z)',sessionType:'Session Type:',fixedTasks:'Fixed Tasks',practiceAll:'Practice All Tables',practiceOne:'Practice One Table',selectTable:'Select table to practice:',tasks:'Tasks:',maxMistakes:'Max Mistakes:',unlimited:'Unlimited',start:'START',back:'Back',backToMenu:'Back to Menu',check:'CHECK',finish:'Finish',learnTables:'Learn Tables',learnHint:'Select a number to see its multiplication table:',tableOf:'Table of',results:'Results',playAgain:'PLAY AGAIN',mastered:'Mastered:',mistakes:'Mistakes:',left:'Left:',practiceAllInfo:'Practice All: Tables 2-{max} ({total} tasks)',perfectMessage:'Perfect! No mistakes!',completedMessage:'Completed with {count} mistake(s) corrected!',noMistakes:'No mistakes! Perfect!',masteredIn:'{label} mastered in',aboutTitle:'About',aboutGoal:'A fun game to help children learn multiplication tables through practice.',aboutAuthor:'by O. Kazimirov',voiceCorrect:'{word}, correct!',voiceWrong:'The answer is {word}',voiceInstallTitle:'Ukrainian Voice Not Found',voiceInstallText:'To hear Ukrainian pronunciation, please install a Ukrainian voice:',voiceInstall:{android:'<b>Android:</b><br>Settings ‚Üí System ‚Üí Languages ‚Üí Text-to-Speech',ios:'<b>iPad/iPhone:</b><br>Settings ‚Üí Accessibility ‚Üí Spoken Content ‚Üí Voices',windows:'<b>Windows:</b><br>Settings ‚Üí Time & Language ‚Üí Speech',other:'Check your device Text-to-Speech settings.'}},
        uk: { menuTitle:'–ì—Ä–∞ –Ω–∞ –ú–Ω–æ–∂–µ–Ω–Ω—è',play:'–ì–†–ê–¢–ò',learn:'–í–ß–ò–¢–ò',settings:'–ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è',practiceUpTo:'–ß–∏—Å–ª–∞ –¥–æ:',questionType:'–¢–∏–ø –ø–∏—Ç–∞–Ω–Ω—è:',findResult:'–ó–Ω–∞–π—Ç–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç (A √ó B = ?)',findMultiplier:'–ó–Ω–∞–π—Ç–∏ –º–Ω–æ–∂–Ω–∏–∫ (? √ó B = Z)',sessionType:'–¢–∏–ø —Å–µ—Å—ñ—ó:',fixedTasks:'–§—ñ–∫—Å–æ–≤–∞–Ω—ñ –∑–∞–≤–¥–∞–Ω–Ω—è',practiceAll:'–í—Å—ñ —Ç–∞–±–ª–∏—Ü—ñ',practiceOne:'–û–¥–Ω–∞ —Ç–∞–±–ª–∏—Ü—è',selectTable:'–û–±–µ—Ä—ñ—Ç—å —Ç–∞–±–ª–∏—Ü—é:',tasks:'–ó–∞–≤–¥–∞–Ω—å:',maxMistakes:'–ú–∞–∫—Å. –ø–æ–º–∏–ª–æ–∫:',unlimited:'–ë–µ–∑ –ª—ñ–º—ñ—Ç—É',start:'–°–¢–ê–†–¢',back:'–ù–∞–∑–∞–¥',backToMenu:'–î–æ –º–µ–Ω—é',check:'–ü–ï–†–ï–í–Ü–†–ò–¢–ò',finish:'–ó–∞–≤–µ—Ä—à–∏—Ç–∏',learnTables:'–í–∏–≤—á–µ–Ω–Ω—è —Ç–∞–±–ª–∏—Ü—å',learnHint:'–û–±–µ—Ä—ñ—Ç—å —á–∏—Å–ª–æ —â–æ–± –ø–æ–±–∞—á–∏—Ç–∏ —Ç–∞–±–ª–∏—Ü—é –º–Ω–æ–∂–µ–Ω–Ω—è:',tableOf:'–¢–∞–±–ª–∏—Ü—è –Ω–∞',results:'–†–µ–∑—É–ª—å—Ç–∞—Ç–∏',playAgain:'–ì–†–ê–¢–ò –ó–ù–û–í–£',mastered:'–í–∏–≤—á–µ–Ω–æ:',mistakes:'–ü–æ–º–∏–ª–æ–∫:',left:'–õ–∏—à–∏–ª–æ—Å—å:',practiceAllInfo:'–í—Å—ñ —Ç–∞–±–ª–∏—Ü—ñ: 2-{max} ({total} –∑–∞–≤–¥–∞–Ω—å)',perfectMessage:'–ß—É–¥–æ–≤–æ! –ë–µ–∑ –ø–æ–º–∏–ª–æ–∫!',completedMessage:'–ó–∞–≤–µ—Ä—à–µ–Ω–æ –∑ {count} –≤–∏–ø—Ä–∞–≤–ª–µ–Ω–∏–º–∏ –ø–æ–º–∏–ª–∫–∞–º–∏!',noMistakes:'–ë–µ–∑ –ø–æ–º–∏–ª–æ–∫! –ß—É–¥–æ–≤–æ!',masteredIn:'{label} –≤–∏–≤—á–µ–Ω–æ –∑–∞',aboutTitle:'–ü—Ä–æ –≥—Ä—É',aboutGoal:'–í–µ—Å–µ–ª–∞ –≥—Ä–∞ –¥–ª—è –≤–∏–≤—á–µ–Ω–Ω—è —Ç–∞–±–ª–∏—Ü—ñ –º–Ω–æ–∂–µ–Ω–Ω—è.',aboutAuthor:'–∞–≤—Ç–æ—Ä –û. –ö–∞–∑—ñ–º—ñ—Ä–æ–≤',voiceCorrect:'{word}, –ø—Ä–∞–≤–∏–ª—å–Ω–æ!',voiceWrong:'–í—ñ–¥–ø–æ–≤—ñ–¥—å: {word}',voiceInstallTitle:'–£–∫—Ä–∞—ó–Ω—Å—å–∫–∏–π –≥–æ–ª–æ—Å –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ',voiceInstallText:'–©–æ–± —á—É—Ç–∏ —É–∫—Ä–∞—ó–Ω—Å—å–∫—É –≤–∏–º–æ–≤—É, –≤—Å—Ç–∞–Ω–æ–≤—ñ—Ç—å —É–∫—Ä–∞—ó–Ω—Å—å–∫–∏–π –≥–æ–ª–æ—Å:',voiceInstall:{android:'<b>Android:</b><br>–ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è ‚Üí –°–∏—Å—Ç–µ–º–∞ ‚Üí –ú–æ–≤–∏ ‚Üí –°–∏–Ω—Ç–µ–∑ –º–æ–≤–ª–µ–Ω–Ω—è',ios:'<b>iPad/iPhone:</b><br>–ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è ‚Üí –î–æ—Å—Ç—É–ø–Ω—ñ—Å—Ç—å ‚Üí –£—Å–Ω–∏–π –≤–º—ñ—Å—Ç ‚Üí –ì–æ–ª–æ—Å–∏',windows:'<b>Windows:</b><br>–ü–∞—Ä–∞–º–µ—Ç—Ä–∏ ‚Üí –ß–∞—Å —ñ –º–æ–≤–∞ ‚Üí –ú–æ–≤–ª–µ–Ω–Ω—è',other:'–ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è —Å–∏–Ω—Ç–µ–∑—É –º–æ–≤–ª–µ–Ω–Ω—è.'}}
    };

    // =========================================================================
    // UTILITY CLASS
    // =========================================================================

    class Utility {
        static $(id) { return document.getElementById(id); }
        static randomInt(min, max) { return Math.floor(Math.random() * (max - min + 1)) + min; }
        static shuffle(arr) { for (let i = arr.length - 1; i > 0; i--) { const j = this.randomInt(0, i); [arr[i], arr[j]] = [arr[j], arr[i]]; } return arr; }
        static pairKey(a, b) { return a < b ? `${a}x${b}` : `${b}x${a}`; }
        static formatTime(ms) { const s = Math.floor(ms / 1000); return `${String(Math.floor(s / 60)).padStart(2, '0')}:${String(s % 60).padStart(2, '0')}`; }
        static getPlatform() {
            const ua = navigator.userAgent;
            const platforms = { ios: /iPad|iPhone|iPod/, android: /Android/, windows: /Windows/ };
            return Object.entries(platforms).find(([, re]) => re.test(ua))?.[0] || 'other';
        }
    }

    // =========================================================================
    // SPEECH SERVICE CLASS
    // =========================================================================

    class SpeechService {
        constructor(state) { this.state = state; }

        speak(text) {
            return new Promise(resolve => {
                if (!this.state.voiceEnabled || !('speechSynthesis' in window)) return resolve();
                window.speechSynthesis.cancel();
                const utterance = new SpeechSynthesisUtterance(text);
                const lang = this.state.voiceLanguage === 'uk' ? 'uk' : 'en';
                const voices = window.speechSynthesis.getVoices();
                const voice = voices.find(v => v.lang.startsWith(lang)) || voices.find(v => v.lang.includes(lang));
                utterance.voice = voice || null;
                utterance.lang = voice?.lang || (lang === 'uk' ? 'uk-UA' : 'en-US');
                utterance.rate = 0.85;
                utterance.pitch = 1.1;
                let done = false;
                const finish = () => { if (!done) { done = true; clearTimeout(timer); resolve(); } };
                utterance.onend = utterance.onerror = finish;
                window.speechSynthesis.speak(utterance);
                const timer = setTimeout(finish, 3000);
            });
        }

        hasVoice(lang) {
            if (!('speechSynthesis' in window)) return false;
            const target = lang === 'uk' ? 'uk' : 'en';
            return window.speechSynthesis.getVoices().some(v => v.lang.startsWith(target) || v.lang.includes(target));
        }

        cancel() { window.speechSynthesis?.cancel(); }
    }

    // =========================================================================
    // NUMBER WORDS CLASS
    // =========================================================================

    class NumberWords {
        static WORDS = {
            en: { ones: ['zero','one','two','three','four','five','six','seven','eight','nine','ten','eleven','twelve','thirteen','fourteen','fifteen','sixteen','seventeen','eighteen','nineteen'], tens: ['','','twenty','thirty','forty','fifty','sixty','seventy','eighty','ninety'], hundred: 'one hundred', sep: '-' },
            uk: { ones: ['–Ω—É–ª—å','–æ–¥–∏–Ω','–¥–≤–∞','—Ç—Ä–∏','—á–æ—Ç–∏—Ä–∏',"–ø'—è—Ç—å",'—à—ñ—Å—Ç—å','—Å—ñ–º','–≤—ñ—Å—ñ–º',"–¥–µ–≤'—è—Ç—å",'–¥–µ—Å—è—Ç—å','–æ–¥–∏–Ω–∞–¥—Ü—è—Ç—å','–¥–≤–∞–Ω–∞–¥—Ü—è—Ç—å','—Ç—Ä–∏–Ω–∞–¥—Ü—è—Ç—å','—á–æ—Ç–∏—Ä–Ω–∞–¥—Ü—è—Ç—å',"–ø'—è—Ç–Ω–∞–¥—Ü—è—Ç—å",'—à—ñ—Å—Ç–Ω–∞–¥—Ü—è—Ç—å','—Å—ñ–º–Ω–∞–¥—Ü—è—Ç—å','–≤—ñ—Å—ñ–º–Ω–∞–¥—Ü—è—Ç—å',"–¥–µ–≤'—è—Ç–Ω–∞–¥—Ü—è—Ç—å"], tens: ['','','–¥–≤–∞–¥—Ü—è—Ç—å','—Ç—Ä–∏–¥—Ü—è—Ç—å','—Å–æ—Ä–æ–∫',"–ø'—è—Ç–¥–µ—Å—è—Ç",'—à—ñ—Å—Ç–¥–µ—Å—è—Ç','—Å—ñ–º–¥–µ—Å—è—Ç','–≤—ñ—Å—ñ–º–¥–µ—Å—è—Ç',"–¥–µ–≤'—è–Ω–æ—Å—Ç–æ"], hundred: '—Å—Ç–æ', sep: ' ' }
        };

        static convert(num, lang) {
            const n = parseInt(num, 10) || 0;
            const w = this.WORDS[lang] || this.WORDS.en;
            if (n < 20) return w.ones[n];
            if (n < 100) { const t = Math.floor(n / 10), o = n % 10; return w.tens[t] + (o > 0 ? w.sep + w.ones[o] : ''); }
            return w.hundred;
        }

        static parse(text, lang) {
            const t = text.toLowerCase().trim().replace(/[.,!?]/g, '');
            const w = this.WORDS[lang] || this.WORDS.en;
            // Direct number anywhere in text
            const numMatch = t.match(/\d+/);
            if (numMatch) return parseInt(numMatch[0], 10);
            // Exact match for ones (0-19)
            for (let i = 0; i < 20; i++) {
                if (t === w.ones[i] || t.split(/\s+/).includes(w.ones[i])) return i;
            }
            // Tens (20-99)
            for (let i = 2; i < 10; i++) {
                if (t.includes(w.tens[i])) {
                    let ones = 0;
                    for (let j = 1; j < 10; j++) {
                        if (t.includes(w.ones[j])) { ones = j; break; }
                    }
                    return i * 10 + ones;
                }
            }
            // Hundred
            if (t.includes(w.hundred.split(' ').pop())) return 100;
            // Fuzzy match - try to find any number word
            for (let i = 0; i < 20; i++) {
                if (t.includes(w.ones[i])) return i;
            }
            return null;
        }
    }

    // =========================================================================
    // SPEECH RECOGNITION SERVICE CLASS
    // =========================================================================

    class SpeechRecognitionService {
        constructor(state, callbacks) {
            this.state = state;
            this.onResult = callbacks.onResult;
            this.onInterim = callbacks.onInterim;
            this.onStop = callbacks.onStop;
            this.recognition = null;
            this.isListening = false;
            this.lastRecognized = null;
            this.supported = 'webkitSpeechRecognition' in window || 'SpeechRecognition' in window;
            if (this.supported) {
                const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                this.recognition = new SpeechRecognition();
                this.recognition.continuous = false;
                this.recognition.interimResults = true;
                this.recognition.maxAlternatives = 5;
                this.recognition.onresult = e => this.handleResult(e);
                this.recognition.onend = () => this.handleEnd();
                this.recognition.onerror = () => this.handleEnd();
            }
        }

        start() {
            if (!this.supported || this.isListening) return false;
            try {
                this.recognition.lang = this.state.voiceLanguage === 'uk' ? 'uk-UA' : 'en-US';
                this.isListening = true;
                this.lastRecognized = null;
                this.recognition.start();
                return true;
            } catch (e) {
                this.isListening = false;
                return false;
            }
        }

        stop() {
            if (this.isListening) {
                this.isListening = false;
                try { this.recognition.abort(); } catch (e) {}
            }
        }

        handleEnd() {
            const wasListening = this.isListening;
            this.isListening = false;
            this.onStop?.();
            if (wasListening && this.lastRecognized !== null) {
                this.onResult(String(this.lastRecognized));
            }
        }

        handleResult(event) {
            for (const result of event.results) {
                for (const alt of result) {
                    const num = NumberWords.parse(alt.transcript, this.state.voiceLanguage);
                    if (num !== null && num >= 0 && num <= 100) {
                        this.lastRecognized = num;
                        this.onInterim?.(String(num));
                        return;
                    }
                }
            }
        }
    }

    // =========================================================================
    // PROBLEM CLASS
    // =========================================================================

    class Problem {
        constructor(a, b, gameMode) {
            if (Math.random() > 0.5) [a, b] = [b, a];
            this.a = a;
            this.b = b;
            this.result = a * b;
            this.key = Utility.pairKey(a, b);
            this.hidden = null;
            this.answer = this.result;
            if (gameMode === 'multiplier') {
                this.hidden = Math.random() > 0.5 ? 'a' : 'b';
                this.answer = this.hidden === 'a' ? a : b;
            }
        }

        getDisplayHTML() {
            const aDisp = this.hidden === 'a' ? '<span class="unknown">?</span>' : this.a;
            const bDisp = this.hidden === 'b' ? '<span class="unknown">?</span>' : this.b;
            return this.hidden ? `${aDisp} √ó ${bDisp} = ${this.result}` : `${this.a} √ó ${this.b} = <span class="unknown">?</span>`;
        }

        getSpeechText(lang) {
            const a = NumberWords.convert(this.a, lang);
            const b = NumberWords.convert(this.b, lang);
            const r = NumberWords.convert(this.result, lang);
            const phrases = {
                result: { en: `${a}, times ${b}`, uk: `${a} –ø–æ–º–Ω–æ–∂–∏—Ç–∏ –Ω–∞ ${b}` },
                a: { en: `What number, times ${b}, equals ${r}`, uk: `–©–æ, –ø–æ–º–Ω–æ–∂–∏—Ç–∏ –Ω–∞ ${b}, –¥–æ—Ä—ñ–≤–Ω—é—î ${r}` },
                b: { en: `${a}, times what number, equals ${r}`, uk: `${a}, –ø–æ–º–Ω–æ–∂–∏—Ç–∏ –Ω–∞ —â–æ, –¥–æ—Ä—ñ–≤–Ω—é—î ${r}` }
            };
            const key = this.hidden || 'result';
            return phrases[key][lang] || phrases[key].en;
        }
    }

    // =========================================================================
    // SESSION STRATEGY CLASSES
    // =========================================================================

    class SessionStrategy {
        constructor(state) { this.state = state; }
        generateProblems() { return []; }
        getTotalCount() { return 0; }
        getLabel(t) { return ''; }
    }

    class FixedSession extends SessionStrategy {
        generateProblems() {
            const problems = [], used = new Set();
            for (let i = 0; i < this.state.totalTasks; i++) {
                let a, b, attempts = 0;
                do {
                    a = Utility.randomInt(CONFIG.GAME.MIN_NUMBER, this.state.maxNumber);
                    b = Utility.randomInt(CONFIG.GAME.MIN_NUMBER, CONFIG.GAME.MAX_NUMBER);
                    if (Math.random() > 0.5) [a, b] = [b, a];
                    attempts++;
                } while (used.has(Utility.pairKey(a, b)) && attempts < 100);
                used.add(Utility.pairKey(a, b));
                problems.push(new Problem(a, b, this.state.gameMode));
            }
            return problems;
        }
        getTotalCount() { return this.state.totalTasks; }
        getLabel(t) { return `${this.state.totalTasks}`; }
    }

    class PracticeAllSession extends SessionStrategy {
        generateProblems() {
            const problems = [], [minB, maxB] = CONFIG.GAME.MULTIPLIER_RANGE;
            for (let a = CONFIG.GAME.MIN_NUMBER; a <= this.state.maxNumber; a++) {
                for (let b = minB; b <= maxB; b++) {
                    problems.push(new Problem(a, b, this.state.gameMode));
                }
            }
            return Utility.shuffle(problems);
        }
        getTotalCount() { return (this.state.maxNumber - 1) * 10; }
        getLabel(t) { return t('practiceAll'); }
    }

    class PracticeOneSession extends SessionStrategy {
        generateProblems() {
            const problems = [], [minB, maxB] = CONFIG.GAME.MULTIPLIER_RANGE;
            for (let b = minB; b <= maxB; b++) {
                problems.push(new Problem(this.state.practiceNumber, b, this.state.gameMode));
            }
            return Utility.shuffle(problems);
        }
        getTotalCount() { return 10; }
        getLabel(t) { return `${t('tableOf')} ${this.state.practiceNumber}`; }
    }

    class SessionFactory {
        static strategies = { fixed: FixedSession, 'practice-all': PracticeAllSession, 'practice-one': PracticeOneSession };
        static create(type, state) { return new (this.strategies[type] || FixedSession)(state); }
    }

    // =========================================================================
    // GAME STATE CLASS
    // =========================================================================

    class GameState {
        constructor() { this.reset(); this.maxNumber = 10; this.practiceNumber = 5; this.gameMode = 'result'; this.sessionType = 'fixed'; this.totalTasks = 10; this.maxMistakes = 3; this.voiceEnabled = true; this.voiceLanguage = 'en'; this.uiLanguage = 'en'; }

        reset() {
            this.currentTask = 0; this.mistakes = 0; this.streak = 0; this.currentAnswer = ''; this.currentProblem = null; this.isProcessing = false;
            this.clearTimer(this.autoSubmitTimer); this.autoSubmitTimer = null;
            this.problemQueue = []; this.masteredPairs = new Set(); this.history = [];
            this.startTime = 0; this.elapsedTime = 0;
            this.clearTimer(this.timerInterval); this.timerInterval = null;
        }

        clearTimer(timer) { timer && clearTimeout(timer); }
        clearAutoSubmit() { this.clearTimer(this.autoSubmitTimer); this.autoSubmitTimer = null; }
        t(key) { return TRANSLATIONS[this.uiLanguage]?.[key] || key; }
        voicePhrase(key, answer) { return this.t(key).replace('{word}', NumberWords.convert(answer, this.voiceLanguage)); }
    }

    // =========================================================================
    // UI CONTROLLER CLASS
    // =========================================================================

    class UIController {
        constructor(state, speech) { this.state = state; this.speech = speech; this.screens = ['menu', 'settings', 'learn', 'game', 'results']; }

        showScreen(name) { this.screens.forEach(s => Utility.$(`${s}-screen`).classList.toggle('active', s === name)); }

        updateLanguage(lang) {
            this.state.uiLanguage = this.state.voiceLanguage = lang;
            const t = TRANSLATIONS[lang];
            if (lang === 'uk' && !this.speech.hasVoice('uk')) setTimeout(() => this.showVoiceHelp(), 300);

            // Update all UI text using mapping
            const textMap = {
                'menu-title': t.menuTitle, 'btn-play': t.play, 'btn-learn': t.learn, 'btn-start': t.start,
                'btn-settings-back': t.back, 'btn-learn-back': t.backToMenu, 'btn-check': t.check,
                'btn-finish': t.finish, 'btn-play-again': t.playAgain, 'btn-results-back': t.backToMenu,
                'about-title': t.aboutTitle, 'about-goal': t.aboutGoal, 'about-author': t.aboutAuthor
            };
            Object.entries(textMap).forEach(([id, text]) => { const el = Utility.$(id); if (el) el.textContent = text; });

            // Selectors
            document.querySelector('#settings-screen h2').textContent = t.settings;
            document.querySelector('#learn-screen h2').textContent = t.learnTables;
            document.querySelector('#results-screen h2').textContent = t.results;
            document.querySelector('.learn-hint').textContent = t.learnHint;

            const labels = document.querySelectorAll('.setting-label');
            [t.practiceUpTo, t.questionType, t.sessionType].forEach((txt, i) => { if (labels[i]) labels[i].textContent = txt; });

            const gameModeSelect = Utility.$('select-game-mode');
            gameModeSelect.options[0].textContent = t.findResult;
            gameModeSelect.options[1].textContent = t.findMultiplier;

            const sessionSelect = Utility.$('select-session-type');
            [t.fixedTasks, t.practiceAll, t.practiceOne].forEach((txt, i) => sessionSelect.options[i].textContent = txt);

            const practiceLabel = document.querySelector('#practice-one-settings .setting-label');
            if (practiceLabel) practiceLabel.textContent = t.selectTable;

            const fixedLabels = document.querySelectorAll('#fixed-mode-settings .setting-label');
            if (fixedLabels[0]) fixedLabels[0].textContent = t.tasks;
            if (fixedLabels[1]) fixedLabels[1].textContent = t.maxMistakes;
            Utility.$('select-max-mistakes').options[3].textContent = t.unlimited;

            this.updateComboCount();
            document.querySelectorAll('.lang-btn').forEach(btn => btn.classList.toggle('selected', btn.dataset.lang === lang));
        }

        showVoiceHelp() {
            const t = TRANSLATIONS[this.state.uiLanguage];
            Utility.$('voice-install-title').textContent = t.voiceInstallTitle;
            Utility.$('voice-install-text').textContent = t.voiceInstallText;
            Utility.$('voice-install-instructions').innerHTML = t.voiceInstall[Utility.getPlatform()] || t.voiceInstall.other;
            Utility.$('voice-install-overlay').classList.add('show');
        }

        async displayProblem(onComplete) {
            Utility.$('display-problem').innerHTML = this.state.currentProblem.getDisplayHTML();
            await this.speech.speak(this.state.currentProblem.getSpeechText(this.state.voiceLanguage));
            if (onComplete) setTimeout(onComplete, 500);
        }

        updateProgress(session) {
            const total = session.getTotalCount();
            const el = Utility.$('display-mistakes');
            Utility.$('display-progress').textContent = `${this.state.t('mastered')} ${this.state.masteredPairs.size} / ${total}`;
            el.textContent = this.state.mistakes > 0 ? `${this.state.t('mistakes')} ${this.state.mistakes} | ${this.state.t('left')} ${this.state.problemQueue.length}` : `${this.state.t('left')} ${this.state.problemQueue.length}`;
            el.className = this.state.mistakes > 0 ? 'mistakes' : 'remaining';
        }

        updateTimer() {
            this.state.elapsedTime = Date.now() - this.state.startTime;
            Utility.$('display-timer').textContent = Utility.formatTime(this.state.elapsedTime);
        }

        updateComboCount() {
            const max = parseInt(Utility.$('input-max-number').value);
            const total = (max - 1) * 10;
            Utility.$('display-combo-count').textContent = this.state.t('practiceAllInfo').replace('{max}', max).replace('{total}', total);
        }

        showTable(number) {
            document.querySelectorAll('#learn-selector .number-btn').forEach(btn => btn.classList.toggle('selected', parseInt(btn.dataset.num) === number));
            Utility.$('table-title').textContent = `${this.state.t('tableOf')} ${number}`;
            Utility.$('table-content').innerHTML = Array.from({length: 10}, (_, i) => `<div class="table-row"><span class="multiplier">${number}</span><span class="operator">√ó</span><span>${i+1}</span><span class="equals">=</span><span class="result">${number * (i+1)}</span></div>`).join('');
            Utility.$('multiplication-table').style.display = 'block';
        }

        showCongrats() {
            const [emoji, text] = CONFIG.CONGRATS[Utility.randomInt(0, CONFIG.CONGRATS.length - 1)];
            Utility.$('congrats-emoji').textContent = emoji;
            Utility.$('congrats-text').textContent = text;
            Utility.$('congrats-subtext').textContent = `${this.state.streak} correct in a row!`;
            Utility.$('congrats-overlay').classList.add('show');
            setTimeout(() => Utility.$('congrats-overlay').classList.remove('show'), CONFIG.TIMING.CONGRATS_DURATION);
        }

        showResults(session) {
            const timeStr = Utility.formatTime(this.state.elapsedTime);
            const total = session.getTotalCount();
            const label = session.getLabel(k => this.state.t(k));

            Utility.$('display-score').textContent = `${total} / ${total}`;
            Utility.$('display-percent').innerHTML = `${this.state.t('masteredIn').replace('{label}', label)} <strong>${timeStr}</strong>`;
            Utility.$('display-score-summary').classList.add('success');

            const gameOverEl = Utility.$('display-game-over');
            gameOverEl.textContent = this.state.mistakes > 0 ? this.state.t('completedMessage').replace('{count}', this.state.mistakes) : this.state.t('perfectMessage');
            gameOverEl.className = 'game-over-message success';
            gameOverEl.style.display = 'block';

            // Collect unique mistakes
            const seen = new Set(), mistakes = [];
            this.state.history.filter(h => !h.correct).forEach(h => {
                const key = `${h.problem.a}x${h.problem.b}`;
                if (!seen.has(key)) { seen.add(key); mistakes.push(h); }
            });

            Utility.$('results-list').innerHTML = mistakes.length === 0
                ? `<div class="result-item correct" style="justify-content:center;color:var(--success-dark);font-weight:600">${this.state.t('noMistakes')}</div>`
                : mistakes.map(h => `<div class="result-item wrong"><span class="result-problem">${h.problem.a} √ó ${h.problem.b} = <s style="color:var(--error)">${h.userAnswer}</s> ‚Üí <strong style="color:var(--success)">${h.problem.result}</strong></span><span class="result-status wrong">‚úó</span></div>`).join('');

            this.showScreen('results');
        }

        resetAnswerDisplay() { const el = Utility.$('display-answer'); el.textContent = ''; el.className = 'answer-display'; }
        updateAnswerDisplay(value) { const el = Utility.$('display-answer'); el.textContent = value; el.className = 'answer-display'; }
        setMicListening(listening) { Utility.$('btn-mic')?.classList.toggle('listening', listening); }

        generateButtons(containerId, onClick) {
            Utility.$(containerId).innerHTML = Array.from({length: CONFIG.GAME.MAX_NUMBER - CONFIG.GAME.MIN_NUMBER + 1}, (_, i) => `<button class="number-btn" data-num="${i + CONFIG.GAME.MIN_NUMBER}">${i + CONFIG.GAME.MIN_NUMBER}</button>`).join('');
            Utility.$(containerId).querySelectorAll('.number-btn').forEach(btn => btn.addEventListener('click', () => onClick(parseInt(btn.dataset.num))));
        }

        generateNumpad() {
            Utility.$('numpad').innerHTML = Array.from({length: 9}, (_, i) => `<button class="num-btn" data-num="${i+1}">${i+1}</button>`).join('') + '<button class="num-btn zero" data-num="0">0</button><button class="num-btn clear" data-num="clear">C</button>';
        }
    }

    // =========================================================================
    // GAME CONTROLLER CLASS
    // =========================================================================

    class GameController {
        constructor(state, ui, speech) {
            this.state = state;
            this.ui = ui;
            this.speech = speech;
            this.session = null;
        }

        start() {
            this.state.maxNumber = parseInt(Utility.$('input-max-number').value);
            this.state.gameMode = Utility.$('select-game-mode').value;
            this.state.sessionType = Utility.$('select-session-type').value;
            this.state.totalTasks = parseInt(Utility.$('select-total-tasks').value);
            this.state.maxMistakes = parseInt(Utility.$('select-max-mistakes').value);
            this.state.reset();

            this.session = SessionFactory.create(this.state.sessionType, this.state);
            this.state.problemQueue = this.session.generateProblems();
            this.state.currentProblem = this.state.problemQueue.shift();

            this.state.startTime = Date.now();
            this.state.timerInterval = setInterval(() => this.ui.updateTimer(), CONFIG.TIMING.TIMER_INTERVAL);
            Utility.$('display-timer').textContent = '00:00';

            this.ui.displayProblem(() => this.autoStartMic());
            this.ui.updateProgress(this.session);
            this.ui.resetAnswerDisplay();
            this.ui.showScreen('game');
        }

        autoStartMic(retries = 3) {
            if (!this.recognizer?.supported || this.state.isProcessing) return;
            this.recognizer.stop();
            setTimeout(() => {
                if (this.state.isProcessing) return;
                if (this.recognizer.start()) {
                    this.ui.setMicListening(true);
                } else if (retries > 0) {
                    this.autoStartMic(retries - 1);
                }
            }, 150);
        }

        async checkAnswer() {
            if (!this.state.currentAnswer || this.state.isProcessing) return;
            this.state.isProcessing = true;
            this.state.clearAutoSubmit();
            try {
                const userAnswer = parseInt(this.state.currentAnswer);
                const problem = this.state.currentProblem;
                const isCorrect = userAnswer === problem.answer;
                this.state.history.push({ problem, userAnswer, correct: isCorrect });
                const answerEl = Utility.$('display-answer');
                answerEl.classList.add(isCorrect ? 'correct' : 'wrong');
                if (isCorrect) {
                    this.state.streak++;
                    this.state.masteredPairs.add(problem.key);
                    answerEl.innerHTML = `${userAnswer} <span style="color:var(--success);font-size:48px;margin-left:12px">‚úì</span>`;
                    await this.speech.speak(this.state.voicePhrase('voiceCorrect', problem.answer));
                    if (this.state.streak % 5 === 0) this.ui.showCongrats();
                } else {
                    this.state.streak = 0;
                    this.state.mistakes++;
                    answerEl.innerHTML = `<s style="color:var(--gray-400)">${userAnswer}</s> <span style="color:var(--gray-400);font-size:24px">‚Üí</span> <span style="color:var(--success);font-size:56px;font-weight:800">${problem.answer}</span>`;
                    await this.speech.speak(this.state.voicePhrase('voiceWrong', problem.answer));
                    const [minPos, maxPos] = CONFIG.GAME.RETRY_POSITION;
                    this.state.problemQueue.splice(Math.min(this.state.problemQueue.length, Utility.randomInt(minPos, maxPos)), 0, new Problem(problem.a, problem.b, this.state.gameMode));
                }
                await new Promise(r => setTimeout(r, isCorrect ? CONFIG.TIMING.CORRECT_DELAY : CONFIG.TIMING.WRONG_DELAY));
                this.state.problemQueue.length === 0 ? this.endGame() : this.nextProblem();
            } finally {
                this.state.isProcessing = false;
            }
        }

        endGame() {
            this.state.clearTimer(this.state.timerInterval);
            this.state.timerInterval = null;
            this.state.elapsedTime = Date.now() - this.state.startTime;
            this.ui.showResults(this.session);
        }

        nextProblem() {
            this.state.currentTask++;
            this.state.currentAnswer = '';
            this.state.currentProblem = this.state.problemQueue.shift();
            this.ui.displayProblem(() => this.autoStartMic());
            this.ui.updateProgress(this.session);
            this.ui.resetAnswerDisplay();
        }

        handleInput(value) {
            if (this.state.isProcessing) return;
            this.state.clearAutoSubmit();
            this.state.currentAnswer = value === 'clear' ? '' : (this.state.currentAnswer.length < 3 ? this.state.currentAnswer + value : this.state.currentAnswer);
            this.ui.updateAnswerDisplay(this.state.currentAnswer);
            if (this.state.currentAnswer && parseInt(this.state.currentAnswer) === this.state.currentProblem.answer) {
                this.checkAnswer();
            } else if (this.state.currentAnswer) {
                this.state.autoSubmitTimer = setTimeout(() => { if (this.state.currentAnswer && !this.state.isProcessing) this.checkAnswer(); }, CONFIG.TIMING.AUTO_SUBMIT_DELAY);
            }
        }

        handleKeyboard(e) {
            if (!Utility.$('game-screen').classList.contains('active') || this.state.isProcessing) return;
            if (e.key >= '0' && e.key <= '9') this.handleInput(e.key);
            else if (e.key === 'Backspace') { this.state.currentAnswer = this.state.currentAnswer.slice(0, -1); this.ui.updateAnswerDisplay(this.state.currentAnswer); }
            else if (e.key === 'Enter') this.checkAnswer();
        }

        finish() {
            this.state.clearTimer(this.state.timerInterval);
            this.state.timerInterval = null;
            this.speech.cancel();
            this.ui.showScreen('menu');
        }

        toggleVoice() {
            this.state.voiceEnabled = !this.state.voiceEnabled;
            Utility.$('btn-voice-toggle').textContent = this.state.voiceEnabled ? 'üîä' : 'üîá';
            Utility.$('btn-voice-toggle').classList.toggle('off', !this.state.voiceEnabled);
            if (!this.state.voiceEnabled) this.speech.cancel();
        }

        handleVoiceResult(value) {
            if (this.state.isProcessing) return;
            this.recognizer?.stop();
            this.state.currentAnswer = value;
            this.ui.updateAnswerDisplay(value);
            this.checkAnswer();
        }

        handleVoiceInterim(value) {
            if (this.state.isProcessing) return;
            this.ui.updateAnswerDisplay(value);
        }

        handleVoiceStop() { this.ui.setMicListening(false); }

        startListening() {
            if (this.state.isProcessing || !this.recognizer?.supported) return;
            this.speech.cancel();
            this.ui.setMicListening(true);
            this.recognizer.start();
        }

        setRecognizer(recognizer) { this.recognizer = recognizer; }
    }

    // =========================================================================
    // APPLICATION CLASS
    // =========================================================================

    class Application {
        constructor() {
            this.state = new GameState();
            this.speech = new SpeechService(this.state);
            this.ui = new UIController(this.state, this.speech);
            this.game = new GameController(this.state, this.ui, this.speech);
            this.recognizer = new SpeechRecognitionService(this.state, {
                onResult: v => this.game.handleVoiceResult(v),
                onInterim: v => this.game.handleVoiceInterim(v),
                onStop: () => this.game.handleVoiceStop()
            });
            this.game.setRecognizer(this.recognizer);
        }

        init() {
            // Generate UI
            this.ui.generateButtons('learn-selector', num => this.ui.showTable(num));
            this.ui.generateButtons('practice-one-selector', num => {
                this.state.practiceNumber = num;
                Utility.$('practice-one-selector').querySelectorAll('.number-btn').forEach(btn => btn.classList.toggle('selected', parseInt(btn.dataset.num) === num));
            });
            this.ui.generateNumpad();
            setTimeout(() => Utility.$('practice-one-selector').querySelectorAll('.number-btn').forEach(btn => btn.classList.toggle('selected', parseInt(btn.dataset.num) === this.state.practiceNumber)), 0);

            // Event bindings
            const on = (id, fn) => Utility.$(id)?.addEventListener('click', fn);
            on('btn-play', () => this.ui.showScreen('settings'));
            on('btn-learn', () => { Utility.$('multiplication-table').style.display = 'none'; document.querySelectorAll('#learn-selector .number-btn').forEach(b => b.classList.remove('selected')); this.ui.showScreen('learn'); });
            on('btn-start', () => this.game.start());
            on('btn-check', () => this.game.checkAnswer());
            on('btn-back-game', () => this.game.finish());
            on('btn-voice-toggle', () => this.game.toggleVoice());
            on('btn-mic', () => this.game.startListening());
            if (!this.recognizer.supported) Utility.$('btn-mic').classList.add('disabled');
            on('btn-settings-back', () => this.ui.showScreen('menu'));
            on('btn-learn-back', () => this.ui.showScreen('menu'));
            on('btn-results-back', () => { Utility.$('display-score-summary').classList.remove('success'); this.ui.showScreen('menu'); });
            on('btn-play-again', () => { Utility.$('display-score-summary').classList.remove('success'); this.ui.showScreen('settings'); });

            // About overlay
            on('btn-about', () => Utility.$('about-overlay').classList.add('show'));
            on('btn-about-close', () => Utility.$('about-overlay').classList.remove('show'));
            Utility.$('about-overlay').addEventListener('click', e => { if (e.target === Utility.$('about-overlay')) Utility.$('about-overlay').classList.remove('show'); });

            // Voice install overlay
            const closeVoice = () => Utility.$('voice-install-overlay').classList.remove('show');
            on('btn-voice-install-close', closeVoice);
            on('btn-voice-install-ok', closeVoice);
            Utility.$('voice-install-overlay').addEventListener('click', e => { if (e.target === Utility.$('voice-install-overlay')) closeVoice(); });

            // Settings
            Utility.$('input-max-number').addEventListener('input', e => { Utility.$('display-max-number').textContent = e.target.value; this.ui.updateComboCount(); });
            Utility.$('select-session-type').addEventListener('change', e => {
                Utility.$('fixed-mode-settings').classList.toggle('hidden', e.target.value !== 'fixed');
                Utility.$('practice-one-settings').style.display = e.target.value === 'practice-one' ? 'block' : 'none';
            });

            // Language
            document.querySelectorAll('.lang-btn').forEach(btn => btn.addEventListener('click', () => this.ui.updateLanguage(btn.dataset.lang)));

            // Numpad
            Utility.$('numpad').querySelectorAll('.num-btn').forEach(btn => btn.addEventListener('click', () => this.game.handleInput(btn.dataset.num)));

            // Keyboard
            document.addEventListener('keydown', e => this.game.handleKeyboard(e));

            // Init
            this.ui.updateComboCount();
            this.ui.updateLanguage('en');

            // Load voices
            if ('speechSynthesis' in window) { window.speechSynthesis.getVoices(); window.speechSynthesis.onvoiceschanged = () => window.speechSynthesis.getVoices(); }
        }
    }

    // Start
    new Application().init();
})();
</script>
</body>
</html>
