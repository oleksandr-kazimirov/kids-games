<!-- Multiplication Game | Oleksandr Kazimirov & Claude AI -->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Multiplication Game</title>
    <style>
        :root {
            --primary: #4A90D9;
            --primary-dark: #357ABD;
            --success: #4CAF50;
            --success-dark: #2E7D32;
            --error: #E53935;
            --error-dark: #C62828;
            --warning: #F57C00;
            --gray-100: #f5f7fa;
            --gray-200: #e4e8ec;
            --gray-300: #e0e0e0;
            --gray-400: #999;
            --gray-600: #666;
            --gray-800: #333;
            --radius-sm: 8px;
            --radius-md: 12px;
            --radius-lg: 16px;
            --radius-xl: 24px;
            --shadow: 0 10px 40px rgba(0,0,0,.1);
            --shadow-btn: 0 4px 15px rgba(74,144,217,.4);
        }

        * { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, var(--gray-100), var(--gray-200));
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        /* Layout */
        .container { width: 100%; max-width: 500px; }

        .screen {
            display: none;
            background: #fff;
            border-radius: var(--radius-xl);
            padding: 32px;
            box-shadow: var(--shadow);
            position: relative;
        }

        .screen.active { display: block; animation: fadeIn .3s ease; }

        /* Animations */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            20%, 60% { transform: translateX(-8px); }
            40%, 80% { transform: translateX(8px); }
        }

        @keyframes popIn {
            0% { transform: scale(.5); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }

        /* Typography */
        h1, h2 { text-align: center; color: var(--gray-800); margin-bottom: 24px; }
        h1 { font-size: 28px; margin-bottom: 32px; }
        h2 { font-size: 24px; }

        /* Form Elements */
        .setting-group { margin-bottom: 24px; }

        .setting-label {
            display: block;
            font-size: 16px;
            color: var(--gray-600);
            margin-bottom: 12px;
            font-weight: 500;
        }

        .slider-container { display: flex; align-items: center; gap: 16px; }

        .slider {
            flex: 1;
            height: 8px;
            -webkit-appearance: none;
            background: var(--gray-300);
            border-radius: 4px;
            outline: none;
        }

        .slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 28px;
            height: 28px;
            background: var(--primary);
            border-radius: 50%;
            cursor: pointer;
            box-shadow: var(--shadow-btn);
        }

        .slider-value {
            font-size: 24px;
            font-weight: 600;
            color: var(--primary);
            min-width: 40px;
            text-align: center;
        }

        .select-wrapper { position: relative; }

        .select-wrapper::after {
            content: '';
            position: absolute;
            right: 20px;
            top: 50%;
            transform: translateY(-50%);
            border: 6px solid transparent;
            border-top-color: var(--gray-600);
            pointer-events: none;
        }

        select {
            width: 100%;
            padding: 16px 20px;
            font-size: 18px;
            border: 2px solid var(--gray-300);
            border-radius: var(--radius-md);
            background: #fff;
            color: var(--gray-800);
            cursor: pointer;
            appearance: none;
            outline: none;
            transition: border-color .2s;
        }

        select:focus { border-color: var(--primary); }

        .settings-row { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }

        .fixed-mode-settings { transition: opacity .3s; overflow: hidden; }
        .fixed-mode-settings.hidden { opacity: .4; pointer-events: none; }

        /* Buttons */
        .btn {
            display: block;
            width: 100%;
            padding: 18px 32px;
            font-size: 20px;
            font-weight: 600;
            border: none;
            border-radius: var(--radius-lg);
            cursor: pointer;
            transition: transform .1s, box-shadow .2s;
            margin-bottom: 12px;
        }

        .btn:last-child { margin-bottom: 0; }
        .btn:active { transform: scale(.97); }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: #fff;
            box-shadow: var(--shadow-btn);
        }

        .btn-secondary {
            background: linear-gradient(135deg, #66BB6A, #43A047);
            color: #fff;
            box-shadow: 0 4px 15px rgba(76,175,80,.4);
        }

        .btn-outline {
            background: #fff;
            color: var(--primary);
            border: 2px solid var(--primary);
            box-shadow: none;
        }

        .btn-outline:active { background: var(--gray-100); }

        /* Game Screen */
        .progress-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 32px;
            padding: 12px 16px;
            background: var(--gray-100);
            border-radius: var(--radius-md);
        }

        .progress-text, .mistakes, .remaining, .timer { font-size: 18px; font-weight: 500; }

        .voice-toggle {
            padding: 4px 8px;
            font-size: 16px;
            border: 2px solid var(--gray-300);
            border-radius: var(--radius-sm);
            background: #fff;
            cursor: pointer;
            transition: all .2s;
        }
        .voice-toggle:active { transform: scale(.95); }
        .voice-toggle.off { opacity: 0.5; }
        .progress-text { color: var(--gray-600); }
        .timer { color: var(--warning); font-family: monospace; font-size: 20px; }
        .mistakes { color: var(--error); }
        .remaining { color: var(--primary); }

        .problem {
            text-align: center;
            font-size: 48px;
            font-weight: 700;
            color: var(--gray-800);
            margin-bottom: 24px;
            padding: 24px;
            background: var(--gray-100);
            border-radius: var(--radius-lg);
            letter-spacing: 4px;
        }

        .problem .unknown { color: var(--primary); font-weight: 800; }

        .answer-display {
            text-align: center;
            font-size: 42px;
            font-weight: 700;
            color: var(--gray-800);
            padding: 20px;
            margin-bottom: 20px;
            background: var(--gray-100);
            border-radius: var(--radius-lg);
            min-height: 80px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background .3s, transform .1s;
        }

        .answer-display.correct { background: #E8F5E9; color: var(--success-dark); }
        .answer-display.wrong { background: #FFEBEE; color: var(--error-dark); animation: shake .4s ease; }

        /* Numpad */
        .numpad { display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; margin-bottom: 20px; }

        .num-btn {
            padding: 20px;
            font-size: 28px;
            font-weight: 600;
            border: none;
            border-radius: var(--radius-lg);
            background: #f0f0f0;
            color: var(--gray-800);
            cursor: pointer;
            transition: background .1s, transform .1s;
        }

        .num-btn:active { background: var(--gray-300); transform: scale(.95); }
        .num-btn.clear { background: #FFEBEE; color: var(--error); }
        .num-btn.zero { grid-column: span 2; }

        /* Results */
        .score-summary {
            text-align: center;
            padding: 24px;
            background: linear-gradient(135deg, #E3F2FD, #BBDEFB);
            border-radius: var(--radius-lg);
            margin-bottom: 24px;
        }

        .score-summary.success { background: linear-gradient(135deg, #E8F5E9, #C8E6C9); }

        .score-big { font-size: 48px; font-weight: 700; color: #1976D2; }
        .score-summary.success .score-big { color: var(--success-dark); }
        .score-percent { font-size: 20px; color: var(--gray-600); margin-top: 8px; }

        .results-list {
            max-height: 300px;
            overflow-y: auto;
            margin-bottom: 24px;
            border: 2px solid var(--gray-300);
            border-radius: var(--radius-lg);
        }

        .result-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px 20px;
            border-bottom: 1px solid #f0f0f0;
            font-size: 18px;
        }

        .result-item:last-child { border-bottom: none; }
        .result-item.correct { background: #F1F8E9; }
        .result-item.wrong { background: #FFEBEE; }

        .result-problem { font-weight: 600; color: var(--gray-800); }
        .result-status { font-weight: 600; }
        .result-status.correct { color: var(--success-dark); }
        .result-status.wrong { color: var(--error-dark); }

        .game-over-message {
            text-align: center;
            padding: 20px;
            background: #FFEBEE;
            border-radius: var(--radius-md);
            margin-bottom: 20px;
            color: var(--error-dark);
            font-weight: 600;
            font-size: 18px;
        }

        .game-over-message.success { background: #E8F5E9; color: var(--success-dark); }

        /* Congrats Overlay */
        .congrats-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: opacity .3s, visibility .3s;
        }

        .congrats-overlay.show { opacity: 1; visibility: visible; }

        .congrats-popup {
            background: #fff;
            padding: 40px;
            border-radius: var(--radius-xl);
            text-align: center;
            transform: scale(.8);
            transition: transform .3s;
            box-shadow: 0 20px 60px rgba(0,0,0,.3);
        }

        .congrats-overlay.show .congrats-popup { transform: scale(1); animation: popIn .4s ease; }

        .congrats-emoji { font-size: 64px; margin-bottom: 16px; }
        .congrats-text { font-size: 28px; font-weight: 700; color: var(--success); margin-bottom: 8px; }
        .congrats-subtext { font-size: 18px; color: var(--gray-600); }

        /* Number Selector */
        .combo-info { font-size: 14px; color: var(--gray-400); margin-top: 8px; text-align: center; }

        .number-selector { display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; margin-bottom: 24px; }

        .number-btn {
            padding: 16px;
            font-size: 24px;
            font-weight: 700;
            border: 3px solid var(--gray-300);
            border-radius: var(--radius-lg);
            background: #fff;
            color: var(--gray-800);
            cursor: pointer;
            transition: all .2s;
        }

        .number-btn:active { transform: scale(.95); }

        .number-btn.selected {
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: #fff;
            border-color: var(--primary-dark);
            box-shadow: var(--shadow-btn);
        }

        /* Language Selector */
        .language-selector { display: flex; gap: 12px; justify-content: center; }

        .lang-btn {
            padding: 12px 20px;
            font-size: 18px;
            font-weight: 600;
            border: 3px solid var(--gray-300);
            border-radius: var(--radius-lg);
            background: #fff;
            color: var(--gray-800);
            cursor: pointer;
            transition: all .2s;
        }

        .lang-btn:active { transform: scale(.95); }

        .lang-btn.selected {
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: #fff;
            border-color: var(--primary-dark);
            box-shadow: var(--shadow-btn);
        }

        /* About Button & Overlay */
        .btn-about {
            position: absolute;
            top: 16px;
            right: 16px;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            border: 2px solid var(--gray-300);
            background: #fff;
            color: var(--gray-600);
            font-size: 18px;
            cursor: pointer;
            transition: all .2s;
        }

        .btn-about:hover { border-color: var(--primary); color: var(--primary); }

        .about-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: opacity .3s, visibility .3s;
        }

        .about-overlay.show { opacity: 1; visibility: visible; }

        .about-popup {
            background: #fff;
            padding: 32px;
            border-radius: var(--radius-xl);
            max-width: 320px;
            text-align: center;
            position: relative;
            box-shadow: 0 20px 60px rgba(0,0,0,.3);
        }

        .about-close {
            position: absolute;
            top: 12px;
            right: 12px;
            width: 28px;
            height: 28px;
            border: none;
            background: var(--gray-100);
            border-radius: 50%;
            font-size: 20px;
            color: var(--gray-600);
            cursor: pointer;
            line-height: 1;
        }

        .about-close:hover { background: var(--gray-200); }

        .about-popup h3 { margin-bottom: 16px; color: var(--gray-800); }
        .about-text { color: var(--gray-600); margin-bottom: 16px; line-height: 1.5; }
        .about-author { color: var(--gray-800); font-weight: 600; margin-bottom: 8px; }
        .about-powered { color: var(--gray-400); font-size: 12px; }

        /* Learn Screen */
        .multiplication-table {
            background: linear-gradient(135deg, #FFF8E1, #FFECB3);
            border-radius: var(--radius-lg);
            padding: 24px;
            margin-bottom: 24px;
        }

        .table-title {
            text-align: center;
            font-size: 24px;
            font-weight: 700;
            color: var(--warning);
            margin-bottom: 20px;
        }

        .table-content { display: flex; flex-direction: column; gap: 8px; }

        .table-row {
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 22px;
            font-weight: 600;
            color: var(--gray-800);
            padding: 8px 16px;
            background: rgba(255,255,255,.7);
            border-radius: var(--radius-sm);
        }

        .table-row span { min-width: 30px; }
        .table-row .multiplier { color: var(--warning); text-align: right; }
        .table-row .operator, .table-row .equals { color: var(--gray-600); margin: 0 8px; min-width: auto; }
        .table-row .result { color: var(--success-dark); font-weight: 700; min-width: 40px; text-align: right; }

        .learn-hint { text-align: center; color: var(--gray-600); font-size: 16px; margin-bottom: 16px; }

        /* Responsive Design */
        @media (max-width: 400px) {
            body { padding: 10px; }
            .screen { padding: 20px; border-radius: var(--radius-lg); }
            h1 { font-size: 24px; margin-bottom: 24px; }
            h2 { font-size: 20px; margin-bottom: 16px; }
            .problem { font-size: 36px; padding: 16px; margin-bottom: 16px; letter-spacing: 2px; }
            .answer-display { font-size: 32px; padding: 16px; min-height: 64px; margin-bottom: 16px; }
            .num-btn { padding: 14px; font-size: 22px; }
            .numpad { gap: 8px; margin-bottom: 16px; }
            .btn { padding: 14px 24px; font-size: 18px; }
            .setting-label { font-size: 14px; margin-bottom: 8px; }
            select { padding: 12px 16px; font-size: 16px; }
            .number-btn { padding: 12px; font-size: 20px; }
            .number-selector { gap: 8px; margin-bottom: 16px; }
            .table-row { font-size: 18px; padding: 6px 12px; }
            .progress-text, .mistakes, .remaining, .timer { font-size: 14px; }
            .progress-bar { padding: 10px 12px; margin-bottom: 20px; }
        }

        @media (min-width: 600px) {
            .container { max-width: 550px; }
            .problem { font-size: 56px; }
            .answer-display { font-size: 48px; min-height: 90px; }
            .num-btn { padding: 24px; font-size: 32px; }
        }

        @media (min-height: 900px) {
            .screen { padding: 40px; }
            .problem { font-size: 60px; padding: 32px; margin-bottom: 32px; }
            .answer-display { font-size: 52px; padding: 28px; min-height: 100px; margin-bottom: 28px; }
            .num-btn { padding: 28px; font-size: 36px; }
            .numpad { gap: 16px; margin-bottom: 28px; }
            .btn { padding: 22px 36px; font-size: 22px; }
        }

        /* Landscape orientation on tablets */
        @media (orientation: landscape) and (max-height: 500px) {
            body { padding: 8px; }
            .screen { padding: 16px; }
            .problem { font-size: 32px; padding: 12px; margin-bottom: 12px; }
            .answer-display { font-size: 28px; padding: 12px; min-height: 50px; margin-bottom: 12px; }
            .num-btn { padding: 10px; font-size: 20px; }
            .numpad { gap: 6px; margin-bottom: 12px; }
            .btn { padding: 12px 20px; font-size: 16px; margin-bottom: 8px; }
            .progress-bar { margin-bottom: 12px; padding: 8px 12px; }
            h2 { font-size: 18px; margin-bottom: 12px; }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Menu Screen -->
        <div id="menu-screen" class="screen active">
            <h1 id="menu-title">Multiplication Game</h1>
            <div class="setting-group" style="margin-bottom:24px">
                <div class="language-selector">
                    <button class="lang-btn selected" data-lang="en">üá¨üáß English</button>
                    <button class="lang-btn" data-lang="uk">üá∫üá¶ –£–∫—Ä–∞—ó–Ω—Å—å–∫–∞</button>
                </div>
            </div>
            <button id="btn-play" class="btn btn-primary">PLAY</button>
            <button id="btn-learn" class="btn btn-secondary">LEARN</button>
            <button id="btn-about" class="btn-about">‚ìò</button>
        </div>

        <!-- Settings Screen -->
        <div id="settings-screen" class="screen">
            <h2>Game Settings</h2>

            <div class="setting-group">
                <label class="setting-label">Practice numbers up to:</label>
                <div class="slider-container">
                    <input type="range" id="input-max-number" class="slider" min="2" max="10" value="10">
                    <span id="display-max-number" class="slider-value">10</span>
                </div>
                <div id="display-combo-count" class="combo-info"></div>
            </div>

            <div class="setting-group">
                <label class="setting-label">Question Type:</label>
                <div class="select-wrapper">
                    <select id="select-game-mode">
                        <option value="result">Find the Result (A √ó B = ?)</option>
                        <option value="multiplier">Find the Multiplier (? √ó B = Z)</option>
                    </select>
                </div>
            </div>

            <div class="setting-group">
                <label class="setting-label">Session Type:</label>
                <div class="select-wrapper">
                    <select id="select-session-type">
                        <option value="fixed">Fixed Tasks</option>
                        <option value="practice-all">Practice All Tables</option>
                        <option value="practice-one">Practice One Table</option>
                    </select>
                </div>
            </div>

            <div id="practice-one-settings" class="setting-group" style="display:none">
                <label class="setting-label">Select table to practice:</label>
                <div class="number-selector" id="practice-one-selector"></div>
            </div>

            <div id="fixed-mode-settings" class="fixed-mode-settings">
                <div class="settings-row">
                    <div class="setting-group">
                        <label class="setting-label">Tasks:</label>
                        <div class="select-wrapper">
                            <select id="select-total-tasks">
                                <option value="5">5</option>
                                <option value="10" selected>10</option>
                                <option value="15">15</option>
                                <option value="20">20</option>
                            </select>
                        </div>
                    </div>
                    <div class="setting-group">
                        <label class="setting-label">Max Mistakes:</label>
                        <div class="select-wrapper">
                            <select id="select-max-mistakes">
                                <option value="1">1</option>
                                <option value="2">2</option>
                                <option value="3" selected>3</option>
                                <option value="0">Unlimited</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>

            <button id="btn-start" class="btn btn-primary">START</button>
            <button id="btn-settings-back" class="btn btn-outline">BACK</button>
        </div>

        <!-- Learn Screen -->
        <div id="learn-screen" class="screen">
            <h2>Learn Tables</h2>
            <p class="learn-hint">Select a number to see its multiplication table:</p>
            <div class="number-selector" id="learn-selector"></div>
            <div id="multiplication-table" class="multiplication-table" style="display:none">
                <div class="table-title" id="table-title"></div>
                <div class="table-content" id="table-content"></div>
            </div>
            <button id="btn-learn-back" class="btn btn-outline">BACK TO MENU</button>
        </div>

        <!-- Game Screen -->
        <div id="game-screen" class="screen">
            <div class="progress-bar">
                <span id="display-progress" class="progress-text"></span>
                <span id="display-timer" class="timer">00:00</span>
                <span id="display-mistakes"></span>
            </div>
            <div id="display-problem" class="problem"></div>
            <div id="display-answer" class="answer-display"></div>
            <div class="numpad" id="numpad"></div>
            <button id="btn-check" class="btn btn-primary">CHECK</button>
            <div style="display:flex;gap:12px">
                <button id="btn-finish" class="btn btn-outline" style="flex:1">FINISH</button>
                <button id="btn-voice-toggle" class="voice-toggle">üîä</button>
            </div>
        </div>

        <!-- Results Screen -->
        <div id="results-screen" class="screen">
            <h2>Results</h2>
            <div id="display-game-over" class="game-over-message" style="display:none"></div>
            <div id="display-score-summary" class="score-summary">
                <div id="display-score" class="score-big"></div>
                <div id="display-percent" class="score-percent"></div>
            </div>
            <div id="results-list" class="results-list"></div>
            <button id="btn-play-again" class="btn btn-primary">PLAY AGAIN</button>
            <button id="btn-results-back" class="btn btn-outline">BACK TO MENU</button>
        </div>
    </div>

    <!-- Congrats Overlay -->
    <div id="congrats-overlay" class="congrats-overlay">
        <div class="congrats-popup">
            <div class="congrats-emoji" id="congrats-emoji"></div>
            <div class="congrats-text" id="congrats-text"></div>
            <div class="congrats-subtext" id="congrats-subtext"></div>
        </div>
    </div>

    <!-- About Overlay -->
    <div id="about-overlay" class="about-overlay">
        <div class="about-popup">
            <button id="btn-about-close" class="about-close">√ó</button>
            <h3 id="about-title">About</h3>
            <p id="about-goal" class="about-text"></p>
            <p id="about-author" class="about-author"></p>
            <p class="about-powered">powered by AI</p>
        </div>
    </div>

    <!-- Voice Install Overlay -->
    <div id="voice-install-overlay" class="about-overlay">
        <div class="about-popup" style="max-width:360px;text-align:left">
            <button id="btn-voice-install-close" class="about-close">√ó</button>
            <h3 id="voice-install-title" style="text-align:center">Ukrainian Voice Not Found</h3>
            <p id="voice-install-text" class="about-text" style="margin-bottom:12px"></p>
            <div id="voice-install-instructions" style="font-size:14px;color:var(--gray-600);line-height:1.6"></div>
            <button id="btn-voice-install-ok" class="btn btn-primary" style="margin-top:16px">OK</button>
        </div>
    </div>

<script>
/**
 * Multiplication Game for Kids
 * A tablet-optimized educational game using vanilla ES6+ JavaScript
 */
(() => {
    'use strict';

    // =========================================================================
    // CONFIGURATION
    // =========================================================================

    const CONFIG = {
        TIMING: {
            CORRECT_DELAY: 1700,
            WRONG_DELAY: 2700,
            CONGRATS_DURATION: 1500,
            TIMER_INTERVAL: 1000
        },
        GAME: {
            MIN_NUMBER: 2,
            MAX_NUMBER: 10,
            MULTIPLIER_RANGE: [1, 10],
            RETRY_POSITION: [3, 7]
        },
        CONGRATS_MESSAGES: [
            ['üåü', 'Great job!'],
            ['üéâ', 'Amazing!'],
            ['üèÜ', 'Fantastic!'],
            ['‚≠ê', 'Super star!'],
            ['üöÄ', 'Excellent!'],
            ['üî•', "You're on fire!"],
            ['üëè', 'Keep it up!'],
            ['üí™', 'Math champion!'],
            ['üéØ', 'Brilliant!'],
            ['‚ú®', 'Outstanding!']
        ]
    };

    // =========================================================================
    // TRANSLATIONS
    // =========================================================================

    const TRANSLATIONS = {
        en: {
            menuTitle: 'Multiplication Game',
            play: 'PLAY',
            learn: 'LEARN',
            settings: 'Game Settings',
            practiceUpTo: 'Practice numbers up to:',
            questionType: 'Question Type:',
            findResult: 'Find the Result (A √ó B = ?)',
            findMultiplier: 'Find the Multiplier (? √ó B = Z)',
            sessionType: 'Session Type:',
            fixedTasks: 'Fixed Tasks',
            practiceAll: 'Practice All Tables',
            practiceOne: 'Practice One Table',
            selectTable: 'Select table to practice:',
            tasks: 'Tasks:',
            maxMistakes: 'Max Mistakes:',
            unlimited: 'Unlimited',
            start: 'START',
            back: 'BACK',
            backToMenu: 'BACK TO MENU',
            check: 'CHECK',
            finish: 'FINISH',
            learnTables: 'Learn Tables',
            learnHint: 'Select a number to see its multiplication table:',
            tableOf: 'Table of',
            results: 'Results',
            playAgain: 'PLAY AGAIN',
            mastered: 'Mastered:',
            mistakes: 'Mistakes:',
            left: 'Left:',
            practiceAllInfo: 'Practice All: Tables 2-{max} ({total} tasks)',
            perfectMessage: 'Perfect! No mistakes!',
            completedMessage: 'Completed with {count} mistake(s) corrected!',
            noMistakes: 'No mistakes! Perfect!',
            masteredIn: '{label} mastered in',
            aboutTitle: 'About',
            aboutGoal: 'A fun game to help children learn multiplication tables through practice. Answer problems, learn from mistakes, and master all tables!',
            aboutAuthor: 'by O. Kazimirov',
            voiceInstallTitle: 'Ukrainian Voice Not Found',
            voiceInstallText: 'To hear Ukrainian pronunciation, please install a Ukrainian voice on your device:',
            voiceInstallAndroid: '<b>Android:</b><br>Settings ‚Üí System ‚Üí Languages ‚Üí Text-to-Speech ‚Üí Install Ukrainian voice',
            voiceInstallIOS: '<b>iPad/iPhone:</b><br>Settings ‚Üí Accessibility ‚Üí Spoken Content ‚Üí Voices ‚Üí Ukrainian ‚Üí Download',
            voiceInstallWindows: '<b>Windows:</b><br>Settings ‚Üí Time & Language ‚Üí Speech ‚Üí Add voices ‚Üí Ukrainian',
            voiceInstallOther: 'Check your device settings for Text-to-Speech or Voice options.'
        },
        uk: {
            menuTitle: '–ì—Ä–∞ –Ω–∞ –ú–Ω–æ–∂–µ–Ω–Ω—è',
            play: '–ì–†–ê–¢–ò',
            learn: '–í–ß–ò–¢–ò',
            settings: '–ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è',
            practiceUpTo: '–ß–∏—Å–ª–∞ –¥–æ:',
            questionType: '–¢–∏–ø –ø–∏—Ç–∞–Ω–Ω—è:',
            findResult: '–ó–Ω–∞–π—Ç–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç (A √ó B = ?)',
            findMultiplier: '–ó–Ω–∞–π—Ç–∏ –º–Ω–æ–∂–Ω–∏–∫ (? √ó B = Z)',
            sessionType: '–¢–∏–ø —Å–µ—Å—ñ—ó:',
            fixedTasks: '–§—ñ–∫—Å–æ–≤–∞–Ω—ñ –∑–∞–≤–¥–∞–Ω–Ω—è',
            practiceAll: '–í—Å—ñ —Ç–∞–±–ª–∏—Ü—ñ',
            practiceOne: '–û–¥–Ω–∞ —Ç–∞–±–ª–∏—Ü—è',
            selectTable: '–û–±–µ—Ä—ñ—Ç—å —Ç–∞–±–ª–∏—Ü—é:',
            tasks: '–ó–∞–≤–¥–∞–Ω—å:',
            maxMistakes: '–ú–∞–∫—Å. –ø–æ–º–∏–ª–æ–∫:',
            unlimited: '–ë–µ–∑ –ª—ñ–º—ñ—Ç—É',
            start: '–°–¢–ê–†–¢',
            back: '–ù–ê–ó–ê–î',
            backToMenu: '–î–û –ú–ï–ù–Æ',
            check: '–ü–ï–†–ï–í–Ü–†–ò–¢–ò',
            finish: '–ó–ê–í–ï–†–®–ò–¢–ò',
            learnTables: '–í–∏–≤—á–µ–Ω–Ω—è —Ç–∞–±–ª–∏—Ü—å',
            learnHint: '–û–±–µ—Ä—ñ—Ç—å —á–∏—Å–ª–æ —â–æ–± –ø–æ–±–∞—á–∏—Ç–∏ —Ç–∞–±–ª–∏—Ü—é –º–Ω–æ–∂–µ–Ω–Ω—è:',
            tableOf: '–¢–∞–±–ª–∏—Ü—è –Ω–∞',
            results: '–†–µ–∑—É–ª—å—Ç–∞—Ç–∏',
            playAgain: '–ì–†–ê–¢–ò –ó–ù–û–í–£',
            mastered: '–í–∏–≤—á–µ–Ω–æ:',
            mistakes: '–ü–æ–º–∏–ª–æ–∫:',
            left: '–õ–∏—à–∏–ª–æ—Å—å:',
            practiceAllInfo: '–í—Å—ñ —Ç–∞–±–ª–∏—Ü—ñ: 2-{max} ({total} –∑–∞–≤–¥–∞–Ω—å)',
            perfectMessage: '–ß—É–¥–æ–≤–æ! –ë–µ–∑ –ø–æ–º–∏–ª–æ–∫!',
            completedMessage: '–ó–∞–≤–µ—Ä—à–µ–Ω–æ –∑ {count} –≤–∏–ø—Ä–∞–≤–ª–µ–Ω–∏–º–∏ –ø–æ–º–∏–ª–∫–∞–º–∏!',
            noMistakes: '–ë–µ–∑ –ø–æ–º–∏–ª–æ–∫! –ß—É–¥–æ–≤–æ!',
            masteredIn: '{label} –≤–∏–≤—á–µ–Ω–æ –∑–∞',
            aboutTitle: '–ü—Ä–æ –≥—Ä—É',
            aboutGoal: '–í–µ—Å–µ–ª–∞ –≥—Ä–∞ –¥–ª—è –≤–∏–≤—á–µ–Ω–Ω—è —Ç–∞–±–ª–∏—Ü—ñ –º–Ω–æ–∂–µ–Ω–Ω—è. –†–æ–∑–≤\'—è–∑—É–π –ø—Ä–∏–∫–ª–∞–¥–∏, –≤—á–∏—Å—å –Ω–∞ –ø–æ–º–∏–ª–∫–∞—Ö —Ç–∞ –æ–ø–∞–Ω—É–π –≤—Å—ñ —Ç–∞–±–ª–∏—Ü—ñ!',
            aboutAuthor: '–∞–≤—Ç–æ—Ä –û. –ö–∞–∑—ñ–º—ñ—Ä–æ–≤',
            voiceInstallTitle: '–£–∫—Ä–∞—ó–Ω—Å—å–∫–∏–π –≥–æ–ª–æ—Å –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ',
            voiceInstallText: '–©–æ–± —á—É—Ç–∏ —É–∫—Ä–∞—ó–Ω—Å—å–∫—É –≤–∏–º–æ–≤—É, –≤—Å—Ç–∞–Ω–æ–≤—ñ—Ç—å —É–∫—Ä–∞—ó–Ω—Å—å–∫–∏–π –≥–æ–ª–æ—Å –Ω–∞ –ø—Ä–∏—Å—Ç—Ä–æ—ó:',
            voiceInstallAndroid: '<b>Android:</b><br>–ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è ‚Üí –°–∏—Å—Ç–µ–º–∞ ‚Üí –ú–æ–≤–∏ ‚Üí –°–∏–Ω—Ç–µ–∑ –º–æ–≤–ª–µ–Ω–Ω—è ‚Üí –í—Å—Ç–∞–Ω–æ–≤–∏—Ç–∏ —É–∫—Ä–∞—ó–Ω—Å—å–∫—É',
            voiceInstallIOS: '<b>iPad/iPhone:</b><br>–ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è ‚Üí –î–æ—Å—Ç—É–ø–Ω—ñ—Å—Ç—å ‚Üí –£—Å–Ω–∏–π –≤–º—ñ—Å—Ç ‚Üí –ì–æ–ª–æ—Å–∏ ‚Üí –£–∫—Ä–∞—ó–Ω—Å—å–∫–∞ ‚Üí –ó–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏',
            voiceInstallWindows: '<b>Windows:</b><br>–ü–∞—Ä–∞–º–µ—Ç—Ä–∏ ‚Üí –ß–∞—Å —ñ –º–æ–≤–∞ ‚Üí –ú–æ–≤–ª–µ–Ω–Ω—è ‚Üí –î–æ–¥–∞—Ç–∏ –≥–æ–ª–æ—Å–∏ ‚Üí –£–∫—Ä–∞—ó–Ω—Å—å–∫–∞',
            voiceInstallOther: '–ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è —Å–∏–Ω—Ç–µ–∑—É –º–æ–≤–ª–µ–Ω–Ω—è –Ω–∞ –≤–∞—à–æ–º—É –ø—Ä–∏—Å—Ç—Ä–æ—ó.'
        }
    };

    // =========================================================================
    // UTILITIES
    // =========================================================================

    const Utils = {
        /** Get element by ID */
        $(id) {
            return document.getElementById(id);
        },

        /** Generate random integer between min and max (inclusive) */
        randomInt(min, max) {
            return Math.floor(Math.random() * (max - min + 1)) + min;
        },

        /** Shuffle array in place using Fisher-Yates algorithm */
        shuffle(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = this.randomInt(0, i);
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        },

        /** Create a unique key for a multiplication pair */
        pairKey(a, b) {
            return a < b ? `${a}x${b}` : `${b}x${a}`;
        },

        /** Format milliseconds as MM:SS */
        formatTime(ms) {
            const totalSeconds = Math.floor(ms / 1000);
            const minutes = Math.floor(totalSeconds / 60);
            const seconds = totalSeconds % 60;
            return `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        },

        /** Speak text using Web Speech API (if enabled). Returns Promise that resolves when done. */
        speak(text, lang = null) {
            return new Promise(resolve => {
                if (!State.voiceEnabled || !('speechSynthesis' in window)) {
                    resolve();
                    return;
                }

                window.speechSynthesis.cancel();
                const utterance = new SpeechSynthesisUtterance(text);
                const language = lang || State.voiceLanguage;
                const targetLang = language === 'uk' ? 'uk' : 'en';

                // Find the best matching voice
                const voices = window.speechSynthesis.getVoices();
                const voice = voices.find(v => v.lang.startsWith(targetLang)) ||
                              voices.find(v => v.lang.includes(targetLang));

                if (voice) {
                    utterance.voice = voice;
                    utterance.lang = voice.lang;
                } else {
                    utterance.lang = language === 'uk' ? 'uk-UA' : 'en-US';
                }

                utterance.rate = 0.85;
                utterance.pitch = 1.1;

                let resolved = false;
                const done = () => {
                    if (!resolved) {
                        resolved = true;
                        clearTimeout(fallbackTimer);
                        resolve();
                    }
                };

                utterance.onend = done;
                utterance.onerror = done;
                window.speechSynthesis.speak(utterance);

                // Fallback timeout in case onend doesn't fire (3 seconds max)
                const fallbackTimer = setTimeout(done, 3000);
            });
        },

        /** Convert number to words in selected language */
        numberToWords(num) {
            const lang = State.voiceLanguage;
            const n = parseInt(num, 10) || 0;

            const wordsEN = {
                ones: ['zero', 'one', 'two', 'three', 'four', 'five', 'six', 'seven', 'eight', 'nine', 'ten',
                       'eleven', 'twelve', 'thirteen', 'fourteen', 'fifteen', 'sixteen', 'seventeen',
                       'eighteen', 'nineteen'],
                tens: ['', '', 'twenty', 'thirty', 'forty', 'fifty', 'sixty', 'seventy', 'eighty', 'ninety'],
                hundred: 'one hundred'
            };

            const wordsUK = {
                ones: ['–Ω—É–ª—å', '–æ–¥–∏–Ω', '–¥–≤–∞', '—Ç—Ä–∏', '—á–æ—Ç–∏—Ä–∏', "–ø'—è—Ç—å", '—à—ñ—Å—Ç—å', '—Å—ñ–º', '–≤—ñ—Å—ñ–º', "–¥–µ–≤'—è—Ç—å", '–¥–µ—Å—è—Ç—å',
                       '–æ–¥–∏–Ω–∞–¥—Ü—è—Ç—å', '–¥–≤–∞–Ω–∞–¥—Ü—è—Ç—å', '—Ç—Ä–∏–Ω–∞–¥—Ü—è—Ç—å', '—á–æ—Ç–∏—Ä–Ω–∞–¥—Ü—è—Ç—å', "–ø'—è—Ç–Ω–∞–¥—Ü—è—Ç—å", '—à—ñ—Å—Ç–Ω–∞–¥—Ü—è—Ç—å',
                       '—Å—ñ–º–Ω–∞–¥—Ü—è—Ç—å', '–≤—ñ—Å—ñ–º–Ω–∞–¥—Ü—è—Ç—å', "–¥–µ–≤'—è—Ç–Ω–∞–¥—Ü—è—Ç—å"],
                tens: ['', '', '–¥–≤–∞–¥—Ü—è—Ç—å', '—Ç—Ä–∏–¥—Ü—è—Ç—å', '—Å–æ—Ä–æ–∫', "–ø'—è—Ç–¥–µ—Å—è—Ç", '—à—ñ—Å—Ç–¥–µ—Å—è—Ç', '—Å—ñ–º–¥–µ—Å—è—Ç',
                       '–≤—ñ—Å—ñ–º–¥–µ—Å—è—Ç', "–¥–µ–≤'—è–Ω–æ—Å—Ç–æ"],
                hundred: '—Å—Ç–æ'
            };

            const words = lang === 'uk' ? wordsUK : wordsEN;

            if (n < 20) return words.ones[n];
            if (n < 100) {
                const t = Math.floor(n / 10);
                const o = n % 10;
                return words.tens[t] + (o > 0 ? (lang === 'uk' ? ' ' : '-') + words.ones[o] : '');
            }
            // 100
            return words.hundred;
        },

        /** Get speech text for problem */
        getProblemSpeech(problem) {
            const lang = State.voiceLanguage;
            const a = this.numberToWords(problem.a);
            const b = this.numberToWords(problem.b);
            const result = this.numberToWords(problem.result);

            if (State.gameMode === 'result') {
                return lang === 'uk'
                    ? `${a} –ø–æ–º–Ω–æ–∂–∏—Ç–∏ –Ω–∞ ${b}`
                    : `${a}, times ${b}`;
            } else {
                if (problem.hidden === 'a') {
                    return lang === 'uk'
                        ? `–©–æ, –ø–æ–º–Ω–æ–∂–∏—Ç–∏ –Ω–∞ ${b}, –¥–æ—Ä—ñ–≤–Ω—é—î ${result}`
                        : `What number, times ${b}, equals ${result}`;
                } else {
                    return lang === 'uk'
                        ? `${a}, –ø–æ–º–Ω–æ–∂–∏—Ç–∏ –Ω–∞ —â–æ, –¥–æ—Ä—ñ–≤–Ω—é—î ${result}`
                        : `${a}, times what number, equals ${result}`;
                }
            }
        },

        /** Get speech text for correct answer */
        getCorrectSpeech(answer) {
            const answerWord = this.numberToWords(answer);
            return State.voiceLanguage === 'uk'
                ? `${answerWord}, –ø—Ä–∞–≤–∏–ª—å–Ω–æ!`
                : `${answerWord}, correct!`;
        },

        /** Get speech text for wrong answer */
        getWrongSpeech(correctAnswer) {
            const answerWord = this.numberToWords(correctAnswer);
            return State.voiceLanguage === 'uk'
                ? `–í—ñ–¥–ø–æ–≤—ñ–¥—å: ${answerWord}`
                : `The answer is ${answerWord}`;
        },

        /** Check if a voice for the given language is available */
        hasVoice(lang) {
            if (!('speechSynthesis' in window)) return false;
            const voices = window.speechSynthesis.getVoices();
            const targetLang = lang === 'uk' ? 'uk' : 'en';
            return voices.some(v => v.lang.startsWith(targetLang) || v.lang.includes(targetLang));
        },

        /** Detect platform */
        getPlatform() {
            const ua = navigator.userAgent;
            if (/iPad|iPhone|iPod/.test(ua)) return 'ios';
            if (/Android/.test(ua)) return 'android';
            if (/Windows/.test(ua)) return 'windows';
            return 'other';
        },

        /** Show voice install instructions */
        showVoiceInstallHelp() {
            const t = TRANSLATIONS[State.uiLanguage];
            const platform = this.getPlatform();

            Utils.$('voice-install-title').textContent = t.voiceInstallTitle;
            Utils.$('voice-install-text').textContent = t.voiceInstallText;

            let instructions = '';
            if (platform === 'android') {
                instructions = t.voiceInstallAndroid;
            } else if (platform === 'ios') {
                instructions = t.voiceInstallIOS;
            } else if (platform === 'windows') {
                instructions = t.voiceInstallWindows;
            } else {
                instructions = t.voiceInstallOther;
            }
            Utils.$('voice-install-instructions').innerHTML = instructions;
            Utils.$('voice-install-overlay').classList.add('show');
        }
    };

    // =========================================================================
    // STATE MANAGEMENT
    // =========================================================================

    const State = {
        // Settings
        maxNumber: 10,
        practiceNumber: 5,
        gameMode: 'result',
        sessionType: 'fixed',
        totalTasks: 10,
        maxMistakes: 3,
        voiceEnabled: true,
        voiceLanguage: 'en',
        uiLanguage: 'en',

        // Game state
        currentTask: 0,
        mistakes: 0,
        streak: 0,
        currentAnswer: '',
        currentProblem: null,
        isProcessing: false,

        // Collections
        usedPairs: new Set(),
        problemQueue: [],
        masteredPairs: new Set(),
        history: [],

        // Timer
        startTime: 0,
        elapsedTime: 0,
        timerInterval: null,

        /** Reset game state for new session */
        reset() {
            this.currentTask = 0;
            this.mistakes = 0;
            this.streak = 0;
            this.currentAnswer = '';
            this.currentProblem = null;
            this.isProcessing = false;
            this.usedPairs.clear();
            this.problemQueue = [];
            this.masteredPairs.clear();
            this.history = [];
            this.startTime = 0;
            this.elapsedTime = 0;
            if (this.timerInterval) {
                clearInterval(this.timerInterval);
                this.timerInterval = null;
            }
        },

        /** Check if current session is a practice mode */
        isPracticeMode() {
            return this.sessionType === 'practice-all' || this.sessionType === 'practice-one';
        }
    };

    // =========================================================================
    // PROBLEM GENERATOR
    // =========================================================================

    const ProblemGenerator = {
        /** Create a problem object from two numbers */
        createProblem(a, b) {
            // Randomly swap positions
            if (Math.random() > 0.5) [a, b] = [b, a];

            const problem = {
                a,
                b,
                result: a * b,
                answer: a * b,
                key: Utils.pairKey(a, b)
            };

            // In multiplier mode, hide one of the factors
            if (State.gameMode === 'multiplier') {
                if (Math.random() > 0.5) {
                    problem.hidden = 'a';
                    problem.answer = a;
                } else {
                    problem.hidden = 'b';
                    problem.answer = b;
                }
            }

            return problem;
        },

        /** Generate all problems for Practice All mode */
        generateAllProblems() {
            const problems = [];
            const [minB, maxB] = CONFIG.GAME.MULTIPLIER_RANGE;

            for (let a = CONFIG.GAME.MIN_NUMBER; a <= State.maxNumber; a++) {
                for (let b = minB; b <= maxB; b++) {
                    problems.push(this.createProblem(a, b));
                }
            }

            return Utils.shuffle(problems);
        },

        /** Generate problems for Practice One mode */
        generateOneTableProblems(number) {
            const problems = [];
            const [minB, maxB] = CONFIG.GAME.MULTIPLIER_RANGE;

            for (let b = minB; b <= maxB; b++) {
                problems.push(this.createProblem(number, b));
            }

            return Utils.shuffle(problems);
        },

        /** Generate a single random problem for Fixed mode */
        generateRandomProblem() {
            let a, b, attempts = 0;

            do {
                a = Utils.randomInt(CONFIG.GAME.MIN_NUMBER, State.maxNumber);
                b = Utils.randomInt(CONFIG.GAME.MIN_NUMBER, CONFIG.GAME.MAX_NUMBER);
                if (Math.random() > 0.5) [a, b] = [b, a];
                attempts++;
            } while (State.usedPairs.has(Utils.pairKey(a, b)) && attempts < 100);

            State.usedPairs.add(Utils.pairKey(a, b));
            return this.createProblem(a, b);
        },

        /** Get next problem from queue */
        getNextProblem() {
            return State.problemQueue.length ? State.problemQueue.shift() : null;
        },

        /** Calculate total combinations for Practice All mode */
        calculateTotalCombinations(maxNumber) {
            return (maxNumber - 1) * 10;
        }
    };

    // =========================================================================
    // UI CONTROLLER
    // =========================================================================

    const UI = {
        screens: ['menu', 'settings', 'learn', 'game', 'results'],

        /** Show a specific screen */
        showScreen(name) {
            this.screens.forEach(screen => {
                Utils.$(`${screen}-screen`).classList.remove('active');
            });
            Utils.$(`${name}-screen`).classList.add('active');
        },

        /** Get translation */
        t(key) {
            return TRANSLATIONS[State.uiLanguage][key] || key;
        },

        /** Update UI language */
        updateLanguage(lang) {
            State.uiLanguage = lang;
            State.voiceLanguage = lang;
            const t = TRANSLATIONS[lang];

            // Check if Ukrainian voice is available
            if (lang === 'uk' && !Utils.hasVoice('uk')) {
                setTimeout(() => Utils.showVoiceInstallHelp(), 300);
            }

            // Menu
            Utils.$('menu-title').textContent = t.menuTitle;
            Utils.$('btn-play').textContent = t.play;
            Utils.$('btn-learn').textContent = t.learn;

            // Settings
            document.querySelector('#settings-screen h2').textContent = t.settings;
            document.querySelectorAll('.setting-label')[0].textContent = t.practiceUpTo;
            document.querySelectorAll('.setting-label')[1].textContent = t.questionType;
            document.querySelectorAll('.setting-label')[2].textContent = t.sessionType;

            const gameModeSelect = Utils.$('select-game-mode');
            gameModeSelect.options[0].textContent = t.findResult;
            gameModeSelect.options[1].textContent = t.findMultiplier;

            const sessionSelect = Utils.$('select-session-type');
            sessionSelect.options[0].textContent = t.fixedTasks;
            sessionSelect.options[1].textContent = t.practiceAll;
            sessionSelect.options[2].textContent = t.practiceOne;

            // Practice one label
            const practiceOneLabel = document.querySelector('#practice-one-settings .setting-label');
            if (practiceOneLabel) practiceOneLabel.textContent = t.selectTable;

            // Fixed mode labels
            const fixedLabels = document.querySelectorAll('#fixed-mode-settings .setting-label');
            if (fixedLabels[0]) fixedLabels[0].textContent = t.tasks;
            if (fixedLabels[1]) fixedLabels[1].textContent = t.maxMistakes;

            const mistakesSelect = Utils.$('select-max-mistakes');
            mistakesSelect.options[3].textContent = t.unlimited;

            Utils.$('btn-start').textContent = t.start;
            Utils.$('btn-settings-back').textContent = t.back;

            // Learn
            document.querySelector('#learn-screen h2').textContent = t.learnTables;
            document.querySelector('.learn-hint').textContent = t.learnHint;
            Utils.$('btn-learn-back').textContent = t.backToMenu;

            // Game
            Utils.$('btn-check').textContent = t.check;
            Utils.$('btn-finish').textContent = t.finish;

            // Results
            document.querySelector('#results-screen h2').textContent = t.results;
            Utils.$('btn-play-again').textContent = t.playAgain;
            Utils.$('btn-results-back').textContent = t.backToMenu;

            // Update combo count
            this.updateComboCount();

            // Update language buttons
            document.querySelectorAll('.lang-btn').forEach(btn => {
                btn.classList.toggle('selected', btn.dataset.lang === lang);
            });

            // Update about
            Utils.$('about-title').textContent = t.aboutTitle;
            Utils.$('about-goal').textContent = t.aboutGoal;
            Utils.$('about-author').textContent = t.aboutAuthor;
        },

        /** Display the current problem */
        displayProblem() {
            const p = State.currentProblem;
            let html;

            if (State.gameMode === 'result') {
                html = `${p.a} √ó ${p.b} = <span class="unknown">?</span>`;
            } else {
                const aDisplay = p.hidden === 'a' ? '<span class="unknown">?</span>' : p.a;
                const bDisplay = p.hidden === 'b' ? '<span class="unknown">?</span>' : p.b;
                html = `${aDisplay} √ó ${bDisplay} = ${p.result}`;
            }

            Utils.$('display-problem').innerHTML = html;
            Utils.speak(Utils.getProblemSpeech(p));
        },

        /** Update progress display */
        updateProgress() {
            const mistakesEl = Utils.$('display-mistakes');
            let total;

            if (State.sessionType === 'practice-one') {
                total = 10;
            } else if (State.sessionType === 'practice-all') {
                total = ProblemGenerator.calculateTotalCombinations(State.maxNumber);
            } else {
                total = State.totalTasks;
            }

            Utils.$('display-progress').textContent = `${this.t('mastered')} ${State.masteredPairs.size} / ${total}`;
            mistakesEl.textContent = State.mistakes > 0
                ? `${this.t('mistakes')} ${State.mistakes} | ${this.t('left')} ${State.problemQueue.length}`
                : `${this.t('left')} ${State.problemQueue.length}`;
            mistakesEl.className = State.mistakes > 0 ? 'mistakes' : 'remaining';
        },

        /** Update timer display */
        updateTimer() {
            State.elapsedTime = Date.now() - State.startTime;
            Utils.$('display-timer').textContent = Utils.formatTime(State.elapsedTime);
        },

        /** Update combo count display in settings */
        updateComboCount() {
            const max = parseInt(Utils.$('input-max-number').value);
            const total = ProblemGenerator.calculateTotalCombinations(max);
            const template = this.t('practiceAllInfo');
            Utils.$('display-combo-count').textContent = template.replace('{max}', max).replace('{total}', total);
        },

        /** Show multiplication table for learning */
        showTable(number) {
            // Update button selection
            document.querySelectorAll('#learn-selector .number-btn').forEach(btn => {
                btn.classList.toggle('selected', parseInt(btn.dataset.num) === number);
            });

            Utils.$('table-title').textContent = `${this.t('tableOf')} ${number}`;

            let html = '';
            for (let i = 1; i <= 10; i++) {
                html += `
                    <div class="table-row">
                        <span class="multiplier">${number}</span>
                        <span class="operator">√ó</span>
                        <span>${i}</span>
                        <span class="equals">=</span>
                        <span class="result">${number * i}</span>
                    </div>`;
            }

            Utils.$('table-content').innerHTML = html;
            Utils.$('multiplication-table').style.display = 'block';
        },

        /** Show congratulations popup */
        showCongrats() {
            const [emoji, text] = CONFIG.CONGRATS_MESSAGES[
                Utils.randomInt(0, CONFIG.CONGRATS_MESSAGES.length - 1)
            ];

            Utils.$('congrats-emoji').textContent = emoji;
            Utils.$('congrats-text').textContent = text;
            Utils.$('congrats-subtext').textContent = `${State.streak} correct in a row!`;
            Utils.$('congrats-overlay').classList.add('show');

            setTimeout(() => {
                Utils.$('congrats-overlay').classList.remove('show');
            }, CONFIG.TIMING.CONGRATS_DURATION);
        },

        /** Show results screen */
        showResults(success) {
            const timeStr = Utils.formatTime(State.elapsedTime);
            const summaryEl = Utils.$('display-score-summary');
            const gameOverEl = Utils.$('display-game-over');

            // Calculate task count based on session type
            let taskCount, label;
            if (State.sessionType === 'practice-one') {
                taskCount = 10;
                label = `${this.t('tableOf')} ${State.practiceNumber}`;
            } else if (State.sessionType === 'practice-all') {
                taskCount = ProblemGenerator.calculateTotalCombinations(State.maxNumber);
                label = this.t('practiceAll');
            } else {
                taskCount = State.totalTasks;
                label = `${taskCount}`;
            }

            Utils.$('display-score').textContent = `${taskCount} / ${taskCount}`;
            const masteredTemplate = this.t('masteredIn');
            Utils.$('display-percent').innerHTML = `${masteredTemplate.replace('{label}', label)} <strong>${timeStr}</strong>`;
            summaryEl.classList.add('success');

            const mistakeCount = State.mistakes;
            if (mistakeCount > 0) {
                gameOverEl.textContent = this.t('completedMessage').replace('{count}', mistakeCount);
            } else {
                gameOverEl.textContent = this.t('perfectMessage');
            }
            gameOverEl.className = 'game-over-message success';
            gameOverEl.style.display = 'block';

            // Show only mistakes
            const mistakes = [];
            const seen = new Set();

            State.history.forEach(h => {
                if (!h.correct) {
                    const key = `${h.problem.a}x${h.problem.b}`;
                    if (!seen.has(key)) {
                        seen.add(key);
                        mistakes.push(h);
                    }
                }
            });

            let html = '';
            if (mistakes.length === 0) {
                html = `<div class="result-item correct" style="justify-content:center;color:var(--success-dark);font-weight:600">${this.t('noMistakes')}</div>`;
            } else {
                mistakes.forEach(h => {
                    const p = h.problem;
                    html += `
                        <div class="result-item wrong">
                            <span class="result-problem">${p.a} √ó ${p.b} = <s style="color:var(--error)">${h.userAnswer}</s> ‚Üí <strong style="color:var(--success)">${p.result}</strong></span>
                            <span class="result-status wrong">‚úó</span>
                        </div>`;
                });
            }

            Utils.$('results-list').innerHTML = html;
            this.showScreen('results');
        },

        /** Reset answer display */
        resetAnswerDisplay() {
            const el = Utils.$('display-answer');
            el.textContent = '';
            el.className = 'answer-display';
        },

        /** Generate number selector buttons */
        generateNumberButtons(containerId, onClick) {
            let html = '';
            for (let i = CONFIG.GAME.MIN_NUMBER; i <= CONFIG.GAME.MAX_NUMBER; i++) {
                html += `<button class="number-btn" data-num="${i}">${i}</button>`;
            }
            Utils.$(containerId).innerHTML = html;

            Utils.$(containerId).querySelectorAll('.number-btn').forEach(btn => {
                btn.addEventListener('click', () => onClick(parseInt(btn.dataset.num)));
            });
        },

        /** Generate numpad buttons */
        generateNumpad() {
            let html = '';
            for (let i = 1; i <= 9; i++) {
                html += `<button class="num-btn" data-num="${i}">${i}</button>`;
            }
            html += '<button class="num-btn zero" data-num="0">0</button>';
            html += '<button class="num-btn clear" data-num="clear">C</button>';
            Utils.$('numpad').innerHTML = html;
        }
    };

    // =========================================================================
    // GAME CONTROLLER
    // =========================================================================

    const Game = {
        /** Start a new game session */
        start() {
            // Load settings
            State.maxNumber = parseInt(Utils.$('input-max-number').value);
            State.gameMode = Utils.$('select-game-mode').value;
            State.sessionType = Utils.$('select-session-type').value;
            State.totalTasks = parseInt(Utils.$('select-total-tasks').value);
            State.maxMistakes = parseInt(Utils.$('select-max-mistakes').value);
            // Voice is always enabled, language is set from menu

            // Reset state
            State.reset();

            // Generate problems based on session type
            if (State.sessionType === 'practice-all') {
                State.problemQueue = ProblemGenerator.generateAllProblems();
            } else if (State.sessionType === 'practice-one') {
                State.problemQueue = ProblemGenerator.generateOneTableProblems(State.practiceNumber);
            } else {
                // Fixed mode: generate queue of random problems
                State.problemQueue = [];
                for (let i = 0; i < State.totalTasks; i++) {
                    State.problemQueue.push(ProblemGenerator.generateRandomProblem());
                }
            }

            // Get first problem from queue
            State.currentProblem = State.problemQueue.shift();

            // Start timer
            State.startTime = Date.now();
            State.timerInterval = setInterval(() => UI.updateTimer(), CONFIG.TIMING.TIMER_INTERVAL);
            Utils.$('display-timer').textContent = '00:00';

            // Update UI
            UI.displayProblem();
            UI.updateProgress();
            UI.resetAnswerDisplay();
            UI.showScreen('game');
        },

        /** Check the current answer */
        async checkAnswer() {
            if (!State.currentAnswer || State.isProcessing) return;
            State.isProcessing = true;

            const userAnswer = parseInt(State.currentAnswer);
            const isCorrect = userAnswer === State.currentProblem.answer;

            // Record in history
            State.history.push({
                problem: State.currentProblem,
                userAnswer,
                correct: isCorrect
            });

            // Update answer display
            const answerEl = Utils.$('display-answer');
            answerEl.classList.add(isCorrect ? 'correct' : 'wrong');

            if (isCorrect) {
                State.streak++;
                State.masteredPairs.add(State.currentProblem.key);
                // Show checkmark for correct answer
                answerEl.innerHTML = `${State.currentAnswer} <span style="color:var(--success);font-size:48px;margin-left:12px">‚úì</span>`;
                await Utils.speak(Utils.getCorrectSpeech(State.currentProblem.answer));
                if (State.streak > 0 && State.streak % 5 === 0) {
                    UI.showCongrats();
                }
            } else {
                State.streak = 0;
                State.mistakes++;

                // Show correct answer (big and green)
                answerEl.innerHTML = `<span style="text-decoration:line-through;color:var(--gray-400)">${State.currentAnswer}</span> <span style="color:var(--gray-400);font-size:24px">‚Üí</span> <span style="color:var(--success);font-size:56px;font-weight:800">${State.currentProblem.answer}</span>`;
                await Utils.speak(Utils.getWrongSpeech(State.currentProblem.answer));

                // Re-queue problem to repeat later (only when wrong)
                const retryProblem = ProblemGenerator.createProblem(
                    State.currentProblem.a,
                    State.currentProblem.b
                );
                const [minPos, maxPos] = CONFIG.GAME.RETRY_POSITION;
                const position = Math.min(State.problemQueue.length, Utils.randomInt(minPos, maxPos));
                State.problemQueue.splice(position, 0, retryProblem);
            }

            // Game ends only when all problems are mastered (queue empty)
            const gameOver = State.problemQueue.length === 0;

            // Wait minimum delay then proceed
            const minDelay = isCorrect ? CONFIG.TIMING.CORRECT_DELAY : CONFIG.TIMING.WRONG_DELAY;
            await new Promise(resolve => setTimeout(resolve, minDelay));

            if (gameOver) {
                if (State.timerInterval) {
                    clearInterval(State.timerInterval);
                    State.timerInterval = null;
                }
                State.elapsedTime = Date.now() - State.startTime;
                UI.showResults(true);
            } else {
                State.currentTask++;
                State.currentAnswer = '';
                State.currentProblem = ProblemGenerator.getNextProblem();
                UI.displayProblem();
                UI.updateProgress();
                UI.resetAnswerDisplay();
            }
            State.isProcessing = false;
        },

        /** Handle numpad input */
        handleNumpadInput(value) {
            if (value === 'clear') {
                State.currentAnswer = '';
            } else if (State.currentAnswer.length < 3) {
                State.currentAnswer += value;
            }

            Utils.$('display-answer').textContent = State.currentAnswer;
            Utils.$('display-answer').className = 'answer-display';

            // Auto-submit on correct answer
            if (State.currentAnswer && parseInt(State.currentAnswer) === State.currentProblem.answer) {
                this.checkAnswer();
            }
        },

        /** Handle keyboard input */
        handleKeyboardInput(event) {
            if (!Utils.$('game-screen').classList.contains('active')) return;

            if (event.key >= '0' && event.key <= '9' && State.currentAnswer.length < 3) {
                State.currentAnswer += event.key;
                Utils.$('display-answer').textContent = State.currentAnswer;
                Utils.$('display-answer').className = 'answer-display';

                // Auto-submit on correct answer
                if (parseInt(State.currentAnswer) === State.currentProblem.answer) {
                    this.checkAnswer();
                }
            } else if (event.key === 'Backspace') {
                State.currentAnswer = State.currentAnswer.slice(0, -1);
                Utils.$('display-answer').textContent = State.currentAnswer;
            } else if (event.key === 'Enter') {
                this.checkAnswer();
            }
        }
    };

    // =========================================================================
    // INITIALIZATION
    // =========================================================================

    const init = () => {
        // Generate UI elements
        UI.generateNumberButtons('learn-selector', num => UI.showTable(num));
        UI.generateNumberButtons('practice-one-selector', num => {
            State.practiceNumber = num;
            Utils.$('practice-one-selector').querySelectorAll('.number-btn').forEach(btn => {
                btn.classList.toggle('selected', parseInt(btn.dataset.num) === num);
            });
        });
        UI.generateNumpad();

        // Set default selection for practice-one
        setTimeout(() => {
            Utils.$('practice-one-selector').querySelectorAll('.number-btn').forEach(btn => {
                btn.classList.toggle('selected', parseInt(btn.dataset.num) === State.practiceNumber);
            });
        }, 0);

        // Menu buttons
        Utils.$('btn-play').addEventListener('click', () => UI.showScreen('settings'));
        Utils.$('btn-learn').addEventListener('click', () => {
            Utils.$('multiplication-table').style.display = 'none';
            document.querySelectorAll('#learn-selector .number-btn').forEach(btn => {
                btn.classList.remove('selected');
            });
            UI.showScreen('learn');
        });

        // Settings controls
        Utils.$('input-max-number').addEventListener('input', e => {
            Utils.$('display-max-number').textContent = e.target.value;
            UI.updateComboCount();
        });

        Utils.$('select-session-type').addEventListener('change', e => {
            const value = e.target.value;
            Utils.$('fixed-mode-settings').classList.toggle('hidden', value !== 'fixed');
            Utils.$('practice-one-settings').style.display = value === 'practice-one' ? 'block' : 'none';
        });

        // Language selector
        document.querySelectorAll('.lang-btn').forEach(btn => {
            btn.addEventListener('click', () => UI.updateLanguage(btn.dataset.lang));
        });

        // About button
        Utils.$('btn-about').addEventListener('click', () => {
            Utils.$('about-overlay').classList.add('show');
        });
        Utils.$('btn-about-close').addEventListener('click', () => {
            Utils.$('about-overlay').classList.remove('show');
        });
        Utils.$('about-overlay').addEventListener('click', e => {
            if (e.target === Utils.$('about-overlay')) {
                Utils.$('about-overlay').classList.remove('show');
            }
        });

        // Voice install popup
        const closeVoiceInstall = () => Utils.$('voice-install-overlay').classList.remove('show');
        Utils.$('btn-voice-install-close').addEventListener('click', closeVoiceInstall);
        Utils.$('btn-voice-install-ok').addEventListener('click', closeVoiceInstall);
        Utils.$('voice-install-overlay').addEventListener('click', e => {
            if (e.target === Utils.$('voice-install-overlay')) closeVoiceInstall();
        });

        // Navigation buttons
        Utils.$('btn-settings-back').addEventListener('click', () => UI.showScreen('menu'));
        Utils.$('btn-learn-back').addEventListener('click', () => UI.showScreen('menu'));
        Utils.$('btn-results-back').addEventListener('click', () => {
            Utils.$('display-score-summary').classList.remove('success');
            UI.showScreen('menu');
        });

        // Game buttons
        Utils.$('btn-start').addEventListener('click', () => Game.start());
        Utils.$('btn-check').addEventListener('click', () => Game.checkAnswer());
        Utils.$('btn-finish').addEventListener('click', () => {
            if (State.timerInterval) {
                clearInterval(State.timerInterval);
                State.timerInterval = null;
            }
            window.speechSynthesis && window.speechSynthesis.cancel();
            UI.showScreen('menu');
        });
        Utils.$('btn-voice-toggle').addEventListener('click', () => {
            State.voiceEnabled = !State.voiceEnabled;
            Utils.$('btn-voice-toggle').textContent = State.voiceEnabled ? 'üîä' : 'üîá';
            Utils.$('btn-voice-toggle').classList.toggle('off', !State.voiceEnabled);
            if (!State.voiceEnabled) {
                window.speechSynthesis && window.speechSynthesis.cancel();
            }
        });
        Utils.$('btn-play-again').addEventListener('click', () => {
            Utils.$('display-score-summary').classList.remove('success');
            UI.showScreen('settings');
        });

        // Numpad events
        Utils.$('numpad').querySelectorAll('.num-btn').forEach(btn => {
            btn.addEventListener('click', () => Game.handleNumpadInput(btn.dataset.num));
        });

        // Keyboard events
        document.addEventListener('keydown', e => Game.handleKeyboardInput(e));

        // Initialize displays
        UI.updateComboCount();
        UI.updateLanguage('en');
    };

    // Load voices (they load asynchronously)
    if ('speechSynthesis' in window) {
        window.speechSynthesis.getVoices();
        window.speechSynthesis.onvoiceschanged = () => {
            window.speechSynthesis.getVoices();
        };
    }

    // Start the app
    init();
})();
</script>
</body>
</html>
